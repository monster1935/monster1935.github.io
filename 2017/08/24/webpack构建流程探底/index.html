<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="记录学习、工作、生活"><title>webpack构建流程探底 | 李茶德的日记</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.4.0/styles/stackoverflow-dark.min.css"><script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.4.0/highlight.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/img/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">webpack构建流程探底</h1><a id="logo" href="/.">李茶德的日记</a><p class="description">记录学习、工作、生活</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa null"> 首页</i></a><a href="/archives/"><i class="fa null"> 归档</i></a><a href="/about/"><i class="fa null"> 关于</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">webpack构建流程探底</h1><div class="post-meta">2017-08-24<span> | </span><span class="category"><a href="/categories/前端/">前端</a></span></div><div class="post-content"><p>本文旨在搞清楚从命令行下敲下 <code>webpack</code> 命令，或者配置 <code>npm script</code> 后执行 <code>package.json</code> 中的命令，到工程目录下出现打包的后的 <code>bundle</code> 文件的过程中，webpack都替我们做了哪些工作。</p>
<a id="more"></a>
<p>测试用webpack版本为 <a href="mailto:**webpack@3.4.1" target="_blank" rel="noopener">**webpack@3.4.1</a>**</p>
<p>webpack.config.js中定义好相关配置，包括 <code>entry</code>、<code>output</code>、<code>module</code>、<code>plugins</code>等，命令行执行 webpack 命令，webpack 便会根据配置文件中的配置进行打包处理文件，并生成最后打包后的文件。</p>
<h4 id="第一步：执行-webpack-命令时，发生了什么？-bin-webpack-js"><a href="#第一步：执行-webpack-命令时，发生了什么？-bin-webpack-js" class="headerlink" title="第一步：执行 webpack 命令时，发生了什么？(bin/webpack.js)"></a>第一步：执行 webpack 命令时，发生了什么？(bin/webpack.js)</h4><p>命令行执行 webpack 时，如果全局命令行中未找到webpack命令的话，执行本地的node-modules/bin/webpack.js 文件。</p>
<p>在bin/webpack.js中使用 <strong>yargs库</strong> 解析了命令行的参数，处理了 webpack 的配置对象 options，调用 <code>processOptions()</code> 函数。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 处理编译相关，核心函数</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">processOptions</span>(<span class="hljs-params">options</span>) </span>&#123;<br>	<span class="hljs-comment">// promise风格的处理，暂时还没遇到这种情况的配置</span><br>	<span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> options.then === <span class="hljs-string">"function"</span>) &#123;...&#125;   <br>    <span class="hljs-comment">// 处理传入的options为数组的情况</span><br>	<span class="hljs-keyword">var</span> firstOptions = [].concat(options)[<span class="hljs-number">0</span>];<br><br>	<span class="hljs-keyword">var</span> statsPresetToOptions = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../lib/Stats.js"</span>).presetToOptions;<br><br>    <span class="hljs-comment">// 设置输出的options</span><br>	<span class="hljs-keyword">var</span> outputOptions = options.stats;<br>	<span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> outputOptions === <span class="hljs-string">"boolean"</span> || <span class="hljs-keyword">typeof</span> outputOptions === <span class="hljs-string">"string"</span>) &#123;<br>		outputOptions = statsPresetToOptions(outputOptions);<br>	&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(!outputOptions) &#123;<br>		outputOptions = &#123;&#125;;<br>	&#125;<br>    <span class="hljs-comment">// 处理各种现实相关的参数</span><br>	ifArg(<span class="hljs-string">"display"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">preset</span>) </span>&#123;<br>		outputOptions = statsPresetToOptions(preset);<br>	&#125;);<br>    ...<br><br>	<span class="hljs-comment">// 引入lib下的webpack.js,入口文件</span><br>	<span class="hljs-keyword">var</span> webpack = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../lib/webpack.js"</span>);<br><br>    <span class="hljs-comment">// 设置最大错误追踪堆栈</span><br>	<span class="hljs-built_in">Error</span>.stackTraceLimit = <span class="hljs-number">30</span>;<br>	<span class="hljs-keyword">var</span> lastHash = <span class="hljs-literal">null</span>;<br>	<span class="hljs-keyword">var</span> compiler;<br>	<span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">// 编译，这里是关键，需要进入lib/webpack.js文件查看</span><br>		compiler = webpack(options);<br>	&#125; <span class="hljs-keyword">catch</span>(e) &#123;<br>        <span class="hljs-comment">// 错误处理</span><br>		<span class="hljs-keyword">var</span> WebpackOptionsValidationError = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../lib/WebpackOptionsValidationError"</span>);<br>		<span class="hljs-keyword">if</span>(e <span class="hljs-keyword">instanceof</span> WebpackOptionsValidationError) &#123;<br>			<span class="hljs-keyword">if</span>(argv.color)<br>				<span class="hljs-built_in">console</span>.error(<span class="hljs-string">"\u001b[1m\u001b[31m"</span> + e.message + <span class="hljs-string">"\u001b[39m\u001b[22m"</span>);<br>			<span class="hljs-keyword">else</span><br>				<span class="hljs-built_in">console</span>.error(e.message);<br>			process.exit(<span class="hljs-number">1</span>); <span class="hljs-comment">// eslint-disable-line no-process-exit</span><br>		&#125;<br>		<span class="hljs-keyword">throw</span> e;<br>	&#125;<br>    <span class="hljs-comment">// 显示相关参数处理</span><br>	<span class="hljs-keyword">if</span>(argv.progress) &#123;<br>		<span class="hljs-keyword">var</span> ProgressPlugin = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../lib/ProgressPlugin"</span>);<br>		compiler.apply(<span class="hljs-keyword">new</span> ProgressPlugin(&#123;<br>			<span class="hljs-attr">profile</span>: argv.profile<br>		&#125;));<br>	&#125;<br>    <span class="hljs-comment">// 编译完后的回调函数</span><br>	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">compilerCallback</span>(<span class="hljs-params">err, stats</span>) </span>&#123;&#125;<br>    <span class="hljs-comment">// watch模式下的处理</span><br>	<span class="hljs-keyword">if</span>(firstOptions.watch || options.watch) &#123;<br>		<span class="hljs-keyword">var</span> watchOptions = firstOptions.watchOptions || firstOptions.watch || options.watch || &#123;&#125;;<br>		<span class="hljs-keyword">if</span>(watchOptions.stdin) &#123;<br>			process.stdin.on(<span class="hljs-string">"end"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>&#123;<br>				process.exit(<span class="hljs-number">0</span>); <span class="hljs-comment">// eslint-disable-line</span><br>			&#125;);<br>			process.stdin.resume();<br>		&#125;<br>		compiler.watch(watchOptions, compilerCallback);<br>		<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"\nWebpack is watching the files…\n"</span>);<br>	&#125; <span class="hljs-keyword">else</span><br>    <span class="hljs-comment">// 调用run()函数，正式进入编译过程</span><br>		compiler.run(compilerCallback);<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="第二步：-调用-webpack，返回-compiler-对象的过程（lib-webpack-js）"><a href="#第二步：-调用-webpack，返回-compiler-对象的过程（lib-webpack-js）" class="headerlink" title="第二步： 调用 webpack，返回 compiler 对象的过程（lib/webpack.js）"></a>第二步： 调用 webpack，返回 compiler 对象的过程（lib/webpack.js）</h4><p>如下图所示，lib/webpack.js 中的关键函数为 webpack，其中定义了编译相关的一些操作。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-meta">"use strict"</span>;<br><span class="hljs-keyword">const</span> Compiler = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./Compiler"</span>);<br><span class="hljs-keyword">const</span> MultiCompiler = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./MultiCompiler"</span>);<br><span class="hljs-keyword">const</span> NodeEnvironmentPlugin = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./node/NodeEnvironmentPlugin"</span>);<br><span class="hljs-keyword">const</span> WebpackOptionsApply = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./WebpackOptionsApply"</span>);<br><span class="hljs-keyword">const</span> WebpackOptionsDefaulter = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./WebpackOptionsDefaulter"</span>);<br><span class="hljs-keyword">const</span> validateSchema = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./validateSchema"</span>);<br><span class="hljs-keyword">const</span> WebpackOptionsValidationError = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./WebpackOptionsValidationError"</span>);<br><span class="hljs-keyword">const</span> webpackOptionsSchema = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../schemas/webpackOptionsSchema.json"</span>);<br><br><span class="hljs-comment">// 核心方法，调用该方法，返回Compiler的实例对象compiler</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">webpack</span>(<span class="hljs-params">options, callback</span>) </span>&#123;...&#125;<br>exports = <span class="hljs-built_in">module</span>.exports = webpack;<br><span class="hljs-comment">// 设置webpack对象的常用属性</span><br>webpack.WebpackOptionsDefaulter = WebpackOptionsDefaulter;<br>webpack.WebpackOptionsApply = WebpackOptionsApply;<br>webpack.Compiler = Compiler;<br>webpack.MultiCompiler = MultiCompiler;<br>webpack.NodeEnvironmentPlugin = NodeEnvironmentPlugin;<br>webpack.validate = validateSchema.bind(<span class="hljs-keyword">this</span>, webpackOptionsSchema);<br>webpack.validateSchema = validateSchema;<br>webpack.WebpackOptionsValidationError = WebpackOptionsValidationError;<br><br><span class="hljs-comment">// 对外暴露一些插件</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">exportPlugins</span>(<span class="hljs-params">obj, mappings</span>) </span>&#123;...&#125;<br><br>exportPlugins(exports, &#123;...&#125;);<br>exportPlugins(exports.optimize = &#123;&#125;, &#123;...&#125;);<br></code></pre></td></tr></table></figure>
<p>接下来看在webpack函数中主要定义了哪些操作<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 核心方法，调用该方法，返回Compiler的实例对象compiler</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">webpack</span>(<span class="hljs-params">options, callback</span>) </span>&#123;<br>    <span class="hljs-comment">// 验证是否符合格式</span><br>	<span class="hljs-keyword">const</span> webpackOptionsValidationErrors = validateSchema(webpackOptionsSchema, options);<br><br>	<span class="hljs-keyword">if</span>(webpackOptionsValidationErrors.length) &#123;<br>		<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> WebpackOptionsValidationError(webpackOptionsValidationErrors);<br>	&#125;<br>	<span class="hljs-keyword">let</span> compiler;<br><br>    <span class="hljs-comment">// 传入的options为数组的情况，调用MultiCompiler进行处理，目前还没遇到过这种情况的配置</span><br>	<span class="hljs-keyword">if</span>(<span class="hljs-built_in">Array</span>.isArray(options)) &#123;<br>		compiler = <span class="hljs-keyword">new</span> MultiCompiler(options.map(<span class="hljs-function"><span class="hljs-params">options</span> =&gt;</span> webpack(options)));<br>	&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> options === <span class="hljs-string">"object"</span>) &#123;<br>		<span class="hljs-comment">// 配置options的默认参数</span><br>		<span class="hljs-keyword">new</span> WebpackOptionsDefaulter().process(options);<br>		<span class="hljs-comment">// 初始化一个Compiler的实例</span><br>		compiler = <span class="hljs-keyword">new</span> Compiler();<br>		<span class="hljs-comment">// 设置context的默认值为进程的当前目录，绝对路径</span><br>		compiler.context = options.context;<br>		<span class="hljs-comment">// 定义compiler的options属性</span><br>		compiler.options = options;<br>		<span class="hljs-comment">// Node环境插件，其中设置compiler的inputFileSystem,outputFileSystem,watchFileSystem,并定义了before-run的钩子函数</span><br>		<span class="hljs-keyword">new</span> NodeEnvironmentPlugin().apply(compiler);<br>		<span class="hljs-comment">// 应用每个插件</span><br>		<span class="hljs-keyword">if</span>(options.plugins &amp;&amp; <span class="hljs-built_in">Array</span>.isArray(options.plugins)) &#123;<br>			compiler.apply.apply(compiler, options.plugins);<br>		&#125;<br>		<span class="hljs-comment">// 调用environment插件</span><br>		compiler.applyPlugins(<span class="hljs-string">"environment"</span>);<br>		<span class="hljs-comment">// 调用after-environment插件</span><br>		compiler.applyPlugins(<span class="hljs-string">"after-environment"</span>);<br>		<span class="hljs-comment">// 处理compiler对象，调用一些必备插件</span><br>		compiler.options = <span class="hljs-keyword">new</span> WebpackOptionsApply().process(options, compiler);<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Invalid argument: options"</span>);<br>	&#125;<br>	<span class="hljs-keyword">if</span>(callback) &#123;<br>		<span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> callback !== <span class="hljs-string">"function"</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Invalid argument: callback"</span>);<br>		<span class="hljs-keyword">if</span>(options.watch === <span class="hljs-literal">true</span> || (<span class="hljs-built_in">Array</span>.isArray(options) &amp;&amp; options.some(<span class="hljs-function"><span class="hljs-params">o</span> =&gt;</span> o.watch))) &#123;<br>			<span class="hljs-keyword">const</span> watchOptions = <span class="hljs-built_in">Array</span>.isArray(options) ? options.map(<span class="hljs-function"><span class="hljs-params">o</span> =&gt;</span> o.watchOptions || &#123;&#125;) : (options.watchOptions || &#123;&#125;);<br>			<span class="hljs-keyword">return</span> compiler.watch(watchOptions, callback);<br>		&#125;<br>		compiler.run(callback);<br>	&#125;<br>	<span class="hljs-keyword">return</span> compiler;<br>&#125;<br></code></pre></td></tr></table></figure></p>
<p>webpack函数中主要做了以下两个操作，</p>
<ul>
<li><p>实例化 Compiler 类。该类继承自 Tapable 类，Tapable 是一个基于发布订阅的插件架构。webpack 便是基于Tapable的发布订阅模式实现的整个流程。Tapable 中通过 plugins 注册插件名，以及对应的回调函数，通过 <code>apply</code>,<code>applyPlugins</code>,<code>applyPluginsWater</code>,<code>applyPluginsAsync</code>等函数以不同的方式调用注册在某一插件下的回调。</p>
</li>
<li><p>通过WebpackOptionsApply 处理webpack compiler对象，通过 compiler.apply的方式调用了一些必备插件，在这些插件中，注册了一些 plugins，在后面的编译过程中，通过调用一些插件的方式，去处理一些流程。</p>
</li>
</ul>
<h4 id="第三步：调用compiler的run的过程-Compiler-js"><a href="#第三步：调用compiler的run的过程-Compiler-js" class="headerlink" title="第三步：调用compiler的run的过程(Compiler.js)"></a>第三步：调用compiler的run的过程(Compiler.js)</h4><ul>
<li><code>run()</code>调用</li>
</ul>
<p>run函数中主要触发了before-run事件，在before-run事件的回调函数中触发了run事件，run事件中调用了readRecord函数读取文件，并调用compile()函数进行编译。</p>
<ul>
<li><code>compile()</code>调用</li>
</ul>
<p>compile函数中定义了编译的相关流程，主要有以下流程：</p>
<ul>
<li>创建编译参数</li>
<li>触发 <code>before-compile</code> 事件，</li>
<li>触发 <code>compile</code> 事件,开始编译</li>
<li>创建 <code>compilation</code>对象，负责整个编译过程中具体细节的对象</li>
<li>触发 <code>make</code> 事件，开始创建模块和分析其依赖</li>
<li>根据入口配置的类型，决定是调用哪个plugin中的 <code>make</code> 事件的回调。如单入口的 <code>entry</code>，调用的是SingleEntryPlugin.js下 <code>make</code> 事件注册的回调函数，其他多入口同理。</li>
<li>调用 <code>compilation</code> 对象的 <code>addEntry</code> 函数，创建模块以及依赖。</li>
<li><code>make</code> 事件的回调函数中，通过<code>seal</code> 封装构建的结果</li>
<li><code>run</code> 方法中定义的 <code>onCompiled</code>回调函数被调用，完成emit过程，将结果写入至目标文件</li>
</ul>
<p>compile函数的定义</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs js">compile(callback) &#123;<br>    <span class="hljs-comment">// 创建编译参数，包括模块工厂和编译依赖参数数组</span><br>	<span class="hljs-keyword">const</span> params = <span class="hljs-keyword">this</span>.newCompilationParams();<br>	<span class="hljs-comment">// 触发before-compile 事件，开始整个编译过程</span><br>	<span class="hljs-keyword">this</span>.applyPluginsAsync(<span class="hljs-string">"before-compile"</span>, params, err =&gt; &#123;<br>		<span class="hljs-keyword">if</span>(err) <span class="hljs-keyword">return</span> callback(err);<br>		<span class="hljs-comment">// 触发compile事件</span><br>		<span class="hljs-keyword">this</span>.applyPlugins(<span class="hljs-string">"compile"</span>, params);<br>		<span class="hljs-comment">// 构建compilation对象，compilation对象负责具体的编译细节</span><br>		<span class="hljs-keyword">const</span> compilation = <span class="hljs-keyword">this</span>.newCompilation(params);<br>        <span class="hljs-comment">// 触发make事件,对应的监听make事件的回调函数在不同的EntryPlugin中注册，比如singleEntryPlugin</span><br>		<span class="hljs-keyword">this</span>.applyPluginsParallel(<span class="hljs-string">"make"</span>, compilation, err =&gt; &#123;<br><br>			<span class="hljs-keyword">if</span>(err) <span class="hljs-keyword">return</span> callback(err);<br><br>			compilation.finish();<br><br>			compilation.seal(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> &#123;<br>				<span class="hljs-keyword">if</span>(err) <span class="hljs-keyword">return</span> callback(err);<br><br>				<span class="hljs-keyword">this</span>.applyPluginsAsync(<span class="hljs-string">"after-compile"</span>, compilation, err =&gt; &#123;<br>					<span class="hljs-keyword">if</span>(err) <span class="hljs-keyword">return</span> callback(err);<br>					<span class="hljs-keyword">return</span> callback(<span class="hljs-literal">null</span>, compilation);<br>				&#125;);<br>			&#125;);<br>		&#125;);<br>	&#125;);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>【问题】<code>make</code> 事件触发后，有哪些插件中注册了make事件并得到了运行的机会呢？</p>
<p>以单入口entry配置为例，在EntryOptionPlugin插件中定义了，不同配置的入口应该调用何种插件进行解析。不同配置的入口插件中注册了对应的 <code>make</code> 事件回调函数，在make事件触发后被调用。</p>
<p>如下所示：</p>
<p><strong>一个插件的<code>apply</code>方法是一个插件的核心方法，当说一个插件被调用时主要是其apply方法被调用。</strong></p>
<p>EntryOptionPlugin 插件在webpackOptionsApply中被调用，其内部定义了使用何种插件来解析入口文件。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> SingleEntryPlugin = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./SingleEntryPlugin"</span>);<br><span class="hljs-keyword">const</span> MultiEntryPlugin = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./MultiEntryPlugin"</span>);<br><span class="hljs-keyword">const</span> DynamicEntryPlugin = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./DynamicEntryPlugin"</span>);<br><br><span class="hljs-built_in">module</span>.exports = <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EntryOptionPlugin</span> </span>&#123;<br>	apply(compiler) &#123;<br>		compiler.plugin(<span class="hljs-string">"entry-option"</span>, (context, entry) =&gt; &#123;<br>			<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">itemToPlugin</span>(<span class="hljs-params">item, name</span>) </span>&#123;<br>				<span class="hljs-keyword">if</span>(<span class="hljs-built_in">Array</span>.isArray(item)) &#123;<br>					<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> MultiEntryPlugin(context, item, name);<br>				&#125; <span class="hljs-keyword">else</span> &#123;<br>					<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> SingleEntryPlugin(context, item, name);<br>				&#125;<br>			&#125;<br>			<span class="hljs-comment">// 判断entry字段的类型去调用不同的入口插件去处理</span><br>			<span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> entry === <span class="hljs-string">"string"</span> || <span class="hljs-built_in">Array</span>.isArray(entry)) &#123;<br>				compiler.apply(itemToPlugin(entry, <span class="hljs-string">"main"</span>));<br>			&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> entry === <span class="hljs-string">"object"</span>) &#123;<br>				<span class="hljs-built_in">Object</span>.keys(entry).forEach(<span class="hljs-function"><span class="hljs-params">name</span> =&gt;</span> compiler.apply(itemToPlugin(entry[name], name)));<br>			&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> entry === <span class="hljs-string">"function"</span>) &#123;<br>				compiler.apply(<span class="hljs-keyword">new</span> DynamicEntryPlugin(context, entry));<br>			&#125;<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>		&#125;);<br>	&#125;<br>&#125;;<br></code></pre></td></tr></table></figure>
<p><code>entry-option</code> 事件被触发时，EntryOptionPlugin 插件做了这几个事情：</p>
<ul>
<li>判断入口的类型，通过 <code>entry</code> 字段来判断，对应了 <code>entry</code> 字段为 <code>string</code> <code>object</code> <code>function</code>的三种情况</li>
<li><p>每种不同的类型调用不同的插件去处理入口的配置。大致处理逻辑如下：</p>
<ul>
<li>数组类型的entry调用multiEntryPlugin插件去处理，对应了多入口的场景</li>
<li>function的entry调用了DynamicEntryPlugin插件去处理，对应了异步chunk的场景</li>
<li>string类型的entry或者object类型的entry，调用SingleEntryPlugin去处理，对应了单入口的场景</li>
</ul>
</li>
</ul>
<p>【问题】<code>entry-option</code> 事件是在什么时机被触发的呢？</p>
<p>如下代码所示，是在WebpackOptionsApply.js中，先调用处理入口的EntryOptionPlugin插件，然后触发 <code>entry-option</code> 事件，去调用不同类型的入口处理插件。</p>
<p><strong>注意：调用插件的过程也就是一个注册事件以及回调函数的过程。</strong></p>
<p>WebpackOptionApply.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 调用处理入口entry的插件</span><br>compiler.apply(<span class="hljs-keyword">new</span> EntryOptionPlugin());<br>compiler.applyPluginsBailResult(<span class="hljs-string">"entry-option"</span>, options.context, options.entry);<br></code></pre></td></tr></table></figure></p>
<p>前面说到，make事件触发时，对应的回调逻辑都在不同配置入口的插件中注册的。下面以SingleEntryPlugin为例，说明从 <code>make</code> 事件被触发，到编译结束的整个过程。</p>
<p>SingleEntryPlugin.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SingleEntryPlugin</span> </span>&#123;<br>	<span class="hljs-keyword">constructor</span>(context, entry, name) &#123;<br>		<span class="hljs-keyword">this</span>.context = context;<br>		<span class="hljs-keyword">this</span>.entry = entry;<br>		<span class="hljs-keyword">this</span>.name = name;<br>	&#125;<br><br>	apply(compiler) &#123;<br>	    <span class="hljs-comment">// compilation 事件在初始化Compilation对象的时候被触发</span><br>		compiler.plugin(<span class="hljs-string">"compilation"</span>, (compilation, params) =&gt; &#123;<br>			<span class="hljs-keyword">const</span> normalModuleFactory = params.normalModuleFactory;<br>			compilation.dependencyFactories.set(SingleEntryDependency, normalModuleFactory);<br>		&#125;);<br>        <span class="hljs-comment">// make 事件在执行compile的时候被触发</span><br>		compiler.plugin(<span class="hljs-string">"make"</span>, (compilation, callback) =&gt; &#123;<br>			<span class="hljs-keyword">const</span> dep = SingleEntryPlugin.createDependency(<span class="hljs-keyword">this</span>.entry, <span class="hljs-keyword">this</span>.name);<br>			<span class="hljs-comment">// 编译的关键，调用Compilation中的addEntry，添加入口，进入编译过程。</span><br>			compilation.addEntry(<span class="hljs-keyword">this</span>.context, dep, <span class="hljs-keyword">this</span>.name, callback);<br>		&#125;);<br>	&#125;<br>	<span class="hljs-keyword">static</span> createDependency(entry, name) &#123;<br>		<span class="hljs-keyword">const</span> dep = <span class="hljs-keyword">new</span> SingleEntryDependency(entry);<br>		dep.loc = name;<br>		<span class="hljs-keyword">return</span> dep;<br>	&#125;<br>&#125;<br><br><span class="hljs-built_in">module</span>.exports = SingleEntryPlugin;<br></code></pre></td></tr></table></figure>
<p>Compilation中负责具体编译的细节，包括如何创建模块以及模块的依赖，根据模板生成js等。如：<code>addEntry</code>,<code>buildModule</code>, <code>processModuleDependencies</code>等。</p>
<p>Compilation.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs js">addEntry(context, entry, name, callback) &#123;<br>	<span class="hljs-keyword">const</span> slot = &#123;<br>		<span class="hljs-attr">name</span>: name,<br>		<span class="hljs-attr">module</span>: <span class="hljs-literal">null</span><br>	&#125;;<br>	<span class="hljs-keyword">this</span>.preparedChunks.push(slot);<br>	<span class="hljs-comment">// 添加该chunk上的module依赖</span><br>	<span class="hljs-keyword">this</span>._addModuleChain(context, entry, (<span class="hljs-built_in">module</span>) =&gt; &#123;<br>		entry.module = <span class="hljs-built_in">module</span>;<br>		<span class="hljs-keyword">this</span>.entries.push(<span class="hljs-built_in">module</span>);<br>		<span class="hljs-built_in">module</span>.issuer = <span class="hljs-literal">null</span>;<br>	&#125;, (err, <span class="hljs-built_in">module</span>) =&gt; &#123;<br>		<span class="hljs-keyword">if</span>(err) &#123;<br>			<span class="hljs-keyword">return</span> callback(err);<br>		&#125;<br><br>		<span class="hljs-keyword">if</span>(<span class="hljs-built_in">module</span>) &#123;<br>			slot.module = <span class="hljs-built_in">module</span>;<br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>			<span class="hljs-keyword">const</span> idx = <span class="hljs-keyword">this</span>.preparedChunks.indexOf(slot);<br>			<span class="hljs-keyword">this</span>.preparedChunks.splice(idx, <span class="hljs-number">1</span>);<br>		&#125;<br>		<span class="hljs-keyword">return</span> callback(<span class="hljs-literal">null</span>, <span class="hljs-built_in">module</span>);<br>	&#125;);<br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs js">_addModuleChain(context, dependency, onModule, callback) &#123;<br>	<span class="hljs-keyword">const</span> start = <span class="hljs-keyword">this</span>.profile &amp;&amp; <span class="hljs-built_in">Date</span>.now();<br>    ...<br><br>	<span class="hljs-comment">// 根据模块的类型获取对应的模块工厂并创建模块</span><br>	<span class="hljs-keyword">const</span> moduleFactory = <span class="hljs-keyword">this</span>.dependencyFactories.get(dependency.constructor);<br>    ...<br>    <span class="hljs-comment">// 创建模块，将创建好的模块module作为参数传递给回调函数</span><br>	moduleFactory.create(&#123;<br>		<span class="hljs-attr">contextInfo</span>: &#123;<br>			<span class="hljs-attr">issuer</span>: <span class="hljs-string">""</span>,<br>			<span class="hljs-attr">compiler</span>: <span class="hljs-keyword">this</span>.compiler.name<br>		&#125;,<br>		<span class="hljs-attr">context</span>: context,<br>		<span class="hljs-attr">dependencies</span>: [dependency]<br>	&#125;, (err, <span class="hljs-built_in">module</span>) =&gt; &#123;<br>		<span class="hljs-keyword">if</span>(err) &#123;<br>			<span class="hljs-keyword">return</span> errorAndCallback(<span class="hljs-keyword">new</span> EntryModuleNotFoundError(err));<br>		&#125;<br><br>		<span class="hljs-keyword">let</span> afterFactory;<br><br>		<span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.profile) &#123;<br>			<span class="hljs-keyword">if</span>(!<span class="hljs-built_in">module</span>.profile) &#123;<br>				<span class="hljs-built_in">module</span>.profile = &#123;&#125;;<br>			&#125;<br>			afterFactory = <span class="hljs-built_in">Date</span>.now();<br>			<span class="hljs-built_in">module</span>.profile.factory = afterFactory - start;<br>		&#125;<br>		<span class="hljs-keyword">const</span> result = <span class="hljs-keyword">this</span>.addModule(<span class="hljs-built_in">module</span>);<br>		<span class="hljs-keyword">if</span>(!result) &#123;<br>			<span class="hljs-built_in">module</span> = <span class="hljs-keyword">this</span>.getModule(<span class="hljs-built_in">module</span>);<br><br>			onModule(<span class="hljs-built_in">module</span>);<br><br>			<span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.profile) &#123;<br>				<span class="hljs-keyword">const</span> afterBuilding = <span class="hljs-built_in">Date</span>.now();<br>				<span class="hljs-built_in">module</span>.profile.building = afterBuilding - afterFactory;<br>			&#125;<br><br>			<span class="hljs-keyword">return</span> callback(<span class="hljs-literal">null</span>, <span class="hljs-built_in">module</span>);<br>		&#125;<br>		<span class="hljs-keyword">if</span>(result <span class="hljs-keyword">instanceof</span> Module) &#123;<br>			<span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.profile) &#123;<br>				result.profile = <span class="hljs-built_in">module</span>.profile;<br>			&#125;<br>			<span class="hljs-built_in">module</span> = result;<br>			onModule(<span class="hljs-built_in">module</span>);<br>			moduleReady.call(<span class="hljs-keyword">this</span>);<br>			<span class="hljs-keyword">return</span>;<br>		&#125;<br>		onModule(<span class="hljs-built_in">module</span>);<br>		<span class="hljs-comment">// 构建模块，包括调用loader处理文件，使用acorn生成AST，遍历AST收集依赖</span><br>		<span class="hljs-keyword">this</span>.buildModule(<span class="hljs-built_in">module</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, (err) =&gt; &#123;<br>			<span class="hljs-keyword">if</span>(err) &#123;<br>				<span class="hljs-keyword">return</span> errorAndCallback(err);<br>			&#125;<br>			<span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.profile) &#123;<br>				<span class="hljs-keyword">const</span> afterBuilding = <span class="hljs-built_in">Date</span>.now();<br>				<span class="hljs-built_in">module</span>.profile.building = afterBuilding - afterFactory;<br>			&#125;<br>            <span class="hljs-comment">// 开始处理收集好的依赖</span><br>			moduleReady.call(<span class="hljs-keyword">this</span>);<br>		&#125;);<br><br>		<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">moduleReady</span>(<span class="hljs-params"></span>) </span>&#123;<br>			<span class="hljs-keyword">this</span>.processModuleDependencies(<span class="hljs-built_in">module</span>, err =&gt; &#123;<br>				<span class="hljs-keyword">if</span>(err) &#123;<br>					<span class="hljs-keyword">return</span> callback(err);<br>				&#125;<br><br>				<span class="hljs-keyword">return</span> callback(<span class="hljs-literal">null</span>, <span class="hljs-built_in">module</span>);<br>			&#125;);<br>		&#125;<br>	&#125;);<br>&#125;<br></code></pre></td></tr></table></figure>
<p><code>_addModuleChain</code> 主要做了以下几件事情：</p>
<ul>
<li>调用对应的模块工厂类去创建module</li>
<li><code>buildModule</code>,开始构建模块，收集依赖。构建过程中最耗时的一步，主要完成了调用loader处理模块以及模块之间的依赖，使用acorn生成AST的过程，遍历AST循环收集并构建依赖模块的过程。此处可以深入了解webpack使用loader处理模块的原理。</li>
</ul>
<h4 id="第四步：模块build完成后，使用seal进行module和chunk的一些处理，包括合并、拆分等。"><a href="#第四步：模块build完成后，使用seal进行module和chunk的一些处理，包括合并、拆分等。" class="headerlink" title="第四步：模块build完成后，使用seal进行module和chunk的一些处理，包括合并、拆分等。"></a>第四步：模块build完成后，使用seal进行module和chunk的一些处理，包括合并、拆分等。</h4><p>Compilation的 <code>seal</code> 函数在 <code>make</code> 事件的回调函数中进行了调用。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><code class="hljs js">seal(callback) &#123;<br>	<span class="hljs-keyword">const</span> self = <span class="hljs-keyword">this</span>;<br>	<span class="hljs-comment">// 触发seal事件，提供其他插件中seal的执行时机</span><br>	self.applyPlugins0(<span class="hljs-string">"seal"</span>);<br>	self.nextFreeModuleIndex = <span class="hljs-number">0</span>;<br>	self.nextFreeModuleIndex2 = <span class="hljs-number">0</span>;<br>	self.preparedChunks.forEach(<span class="hljs-function"><span class="hljs-params">preparedChunk</span> =&gt;</span> &#123;<br>		<span class="hljs-keyword">const</span> <span class="hljs-built_in">module</span> = preparedChunk.module;<br>		<span class="hljs-comment">// 将module保存在chunk的origins中，origins保存了module的信息</span><br>		<span class="hljs-keyword">const</span> chunk = self.addChunk(preparedChunk.name, <span class="hljs-built_in">module</span>);<br>		<span class="hljs-comment">// 创建一个entrypoint</span><br>		<span class="hljs-keyword">const</span> entrypoint = self.entrypoints[chunk.name] = <span class="hljs-keyword">new</span> Entrypoint(chunk.name);<br>		<span class="hljs-comment">// 将chunk创建的chunk保存在entrypoint中，并将该entrypoint的实例保存在chunk的entrypoints中</span><br>		entrypoint.unshiftChunk(chunk);<br>		<span class="hljs-comment">// 将module保存在chunk的_modules数组中</span><br>		chunk.addModule(<span class="hljs-built_in">module</span>);<br>		<span class="hljs-comment">// module实例上记录chunk的信息</span><br>		<span class="hljs-built_in">module</span>.addChunk(chunk);<br>		<span class="hljs-comment">// 定义该chunk的entryModule属性</span><br>		chunk.entryModule = <span class="hljs-built_in">module</span>;<br>		self.assignIndex(<span class="hljs-built_in">module</span>);<br>		self.assignDepth(<span class="hljs-built_in">module</span>);<br>		self.processDependenciesBlockForChunk(<span class="hljs-built_in">module</span>, chunk);<br>	&#125;);<br>	self.sortModules(self.modules);<br>	self.applyPlugins0(<span class="hljs-string">"optimize"</span>);<br><br>	<span class="hljs-keyword">while</span>(self.applyPluginsBailResult1(<span class="hljs-string">"optimize-modules-basic"</span>, self.modules) ||<br>		self.applyPluginsBailResult1(<span class="hljs-string">"optimize-modules"</span>, self.modules) ||<br>		self.applyPluginsBailResult1(<span class="hljs-string">"optimize-modules-advanced"</span>, self.modules)) &#123; <span class="hljs-comment">/* empty */</span> &#125;<br>	self.applyPlugins1(<span class="hljs-string">"after-optimize-modules"</span>, self.modules);<br><br>	<span class="hljs-keyword">while</span>(self.applyPluginsBailResult1(<span class="hljs-string">"optimize-chunks-basic"</span>, self.chunks) ||<br>		self.applyPluginsBailResult1(<span class="hljs-string">"optimize-chunks"</span>, self.chunks) ||<br>		self.applyPluginsBailResult1(<span class="hljs-string">"optimize-chunks-advanced"</span>, self.chunks)) &#123; <span class="hljs-comment">/* empty */</span> &#125;<br>	self.applyPlugins1(<span class="hljs-string">"after-optimize-chunks"</span>, self.chunks);<br><br>	self.applyPluginsAsyncSeries(<span class="hljs-string">"optimize-tree"</span>, self.chunks, self.modules, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sealPart2</span>(<span class="hljs-params">err</span>) </span>&#123;<br>		<span class="hljs-keyword">if</span>(err) &#123;<br>			<span class="hljs-keyword">return</span> callback(err);<br>		&#125;<br><br>		self.applyPlugins2(<span class="hljs-string">"after-optimize-tree"</span>, self.chunks, self.modules);<br><br>		<span class="hljs-keyword">while</span>(self.applyPluginsBailResult(<span class="hljs-string">"optimize-chunk-modules-basic"</span>, self.chunks, self.modules) ||<br>			self.applyPluginsBailResult(<span class="hljs-string">"optimize-chunk-modules"</span>, self.chunks, self.modules) ||<br>			self.applyPluginsBailResult(<span class="hljs-string">"optimize-chunk-modules-advanced"</span>, self.chunks, self.modules)) &#123; <span class="hljs-comment">/* empty */</span> &#125;<br>		self.applyPlugins2(<span class="hljs-string">"after-optimize-chunk-modules"</span>, self.chunks, self.modules);<br><br>		<span class="hljs-keyword">const</span> shouldRecord = self.applyPluginsBailResult(<span class="hljs-string">"should-record"</span>) !== <span class="hljs-literal">false</span>;<br><br>		self.applyPlugins2(<span class="hljs-string">"revive-modules"</span>, self.modules, self.records);<br>		self.applyPlugins1(<span class="hljs-string">"optimize-module-order"</span>, self.modules);<br>		self.applyPlugins1(<span class="hljs-string">"advanced-optimize-module-order"</span>, self.modules);<br>		self.applyPlugins1(<span class="hljs-string">"before-module-ids"</span>, self.modules);<br>		self.applyPlugins1(<span class="hljs-string">"module-ids"</span>, self.modules);<br>		self.applyModuleIds();<br>		self.applyPlugins1(<span class="hljs-string">"optimize-module-ids"</span>, self.modules);<br>		self.applyPlugins1(<span class="hljs-string">"after-optimize-module-ids"</span>, self.modules);<br><br>		self.sortItemsWithModuleIds();<br><br>		self.applyPlugins2(<span class="hljs-string">"revive-chunks"</span>, self.chunks, self.records);<br>		self.applyPlugins1(<span class="hljs-string">"optimize-chunk-order"</span>, self.chunks);<br>		self.applyPlugins1(<span class="hljs-string">"before-chunk-ids"</span>, self.chunks);<br>		self.applyChunkIds();<br>		self.applyPlugins1(<span class="hljs-string">"optimize-chunk-ids"</span>, self.chunks);<br>		self.applyPlugins1(<span class="hljs-string">"after-optimize-chunk-ids"</span>, self.chunks);<br><br>		self.sortItemsWithChunkIds();<br><br>		<span class="hljs-keyword">if</span>(shouldRecord)<br>			self.applyPlugins2(<span class="hljs-string">"record-modules"</span>, self.modules, self.records);<br>		<span class="hljs-keyword">if</span>(shouldRecord)<br>			self.applyPlugins2(<span class="hljs-string">"record-chunks"</span>, self.chunks, self.records);<br><br>		self.applyPlugins0(<span class="hljs-string">"before-hash"</span>);<br>		<span class="hljs-comment">// 创建hash</span><br>		self.createHash();<br>		self.applyPlugins0(<span class="hljs-string">"after-hash"</span>);<br><br>		<span class="hljs-keyword">if</span>(shouldRecord)<br>			self.applyPlugins1(<span class="hljs-string">"record-hash"</span>, self.records);<br><br>		self.applyPlugins0(<span class="hljs-string">"before-module-assets"</span>);<br>		self.createModuleAssets();<br>		<span class="hljs-keyword">if</span>(self.applyPluginsBailResult(<span class="hljs-string">"should-generate-chunk-assets"</span>) !== <span class="hljs-literal">false</span>) &#123;<br>			self.applyPlugins0(<span class="hljs-string">"before-chunk-assets"</span>);<br>			<span class="hljs-comment">// 使用template创建最后的js代码</span><br>			self.createChunkAssets();<br>		&#125;<br>		self.applyPlugins1(<span class="hljs-string">"additional-chunk-assets"</span>, self.chunks);<br>		self.summarizeDependencies();<br>		<span class="hljs-keyword">if</span>(shouldRecord)<br>			self.applyPlugins2(<span class="hljs-string">"record"</span>, self, self.records);<br><br>		self.applyPluginsAsync(<span class="hljs-string">"additional-assets"</span>, err =&gt; &#123;<br>			<span class="hljs-keyword">if</span>(err) &#123;<br>				<span class="hljs-keyword">return</span> callback(err);<br>			&#125;<br>			self.applyPluginsAsync(<span class="hljs-string">"optimize-chunk-assets"</span>, self.chunks, err =&gt; &#123;<br>				<span class="hljs-keyword">if</span>(err) &#123;<br>					<span class="hljs-keyword">return</span> callback(err);<br>				&#125;<br>				self.applyPlugins1(<span class="hljs-string">"after-optimize-chunk-assets"</span>, self.chunks);<br>				self.applyPluginsAsync(<span class="hljs-string">"optimize-assets"</span>, self.assets, err =&gt; &#123;<br>					<span class="hljs-keyword">if</span>(err) &#123;<br>						<span class="hljs-keyword">return</span> callback(err);<br>					&#125;<br>					self.applyPlugins1(<span class="hljs-string">"after-optimize-assets"</span>, self.assets);<br>					<span class="hljs-keyword">if</span>(self.applyPluginsBailResult(<span class="hljs-string">"need-additional-seal"</span>)) &#123;<br>						self.unseal();<br>						<span class="hljs-keyword">return</span> self.seal(callback);<br>					&#125;<br>					<span class="hljs-keyword">return</span> self.applyPluginsAsync(<span class="hljs-string">"after-seal"</span>, callback);<br>				&#125;);<br>			&#125;);<br>		&#125;);<br>	&#125;);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>在 <code>seal</code> 中可以发现，调用了很多不同的插件，主要就是操作chunk和module的一些插件，生成最后的源代码。其中 <code>createHash</code> 用来生成hash，<code>createChunkAssets</code> 用来生成chunk的源码，<code>createModuleAssets</code> 用来生成Module的源码。在 <code>createChunkAssets</code> 中判断了是否是入口chunk，入口的chunk用mainTemplate生成，否则用chunkTemplate生成。</p>
<h4 id="第五步：通过-emitAssets-将生成的代码输入到output的指定位置"><a href="#第五步：通过-emitAssets-将生成的代码输入到output的指定位置" class="headerlink" title="第五步：通过 emitAssets 将生成的代码输入到output的指定位置"></a>第五步：通过 <code>emitAssets</code> 将生成的代码输入到output的指定位置</h4><p>在compiler中的 <code>run</code> 方法中定义了compile的回调函数 <code>onCompiled</code>, 在编译结束后，会调用该回调函数。在该回调函数中调用了 <code>emitAsset</code>，触发了 <code>emit</code> 事件，将文件写入到文件系统中的指定位置。</p>
<h4 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h4><p>webpack的源码通过采用Tapable控制其事件流，并通过plugin机制，在webpack构建过程中将一些事件钩子暴露给plugin,使得开发者可以通过编写相应的插件来自定义打包。</p>
<p>参考文章：</p>
<p><a href="http://taobaofed.org/blog/2016/09/09/webpack-flow/" target="_blank" rel="noopener">细说 webpack 之流程篇</a></p>
<p><a href="https://lihuanghe.github.io/2016/05/30/webpack-event.html" target="_blank" rel="noopener">webpack 源码解析</a></p>
</div><div class="tags"><a href="/tags/webpack/">webpack</a><a href="/tags/模块打包/">模块打包</a><a href="/tags/源码阅读/">源码阅读</a></div><div class="post-nav"><a href="/2017/08/24/webpack学习系列/" class="pre">webpack学习系列</a><a href="/2017/08/24/vue-cli中的webpack模板配置学习/" class="next">vue-cli中的webpack模板配置学习</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="widget-title"><span>分类</span></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/LeetCode/">LeetCode</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Node/">Node</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/前端/">前端</a><span class="category-list-count">34</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/博客搭建/">博客搭建</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/客户端/">客户端</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工作/">工作</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/影视/">影视</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/生活/">生活</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/算法/">算法</a><span class="category-list-count">1</span></li></ul></div><div class="widget"><div class="widget-title"><span>最近文章</span></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2021/07/12/与自己和解/">与自己和解</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/06/25/读未来简史/">读未来简史</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/05/10/读心：稻盛和夫一生的嘱托/">读心：稻盛和夫一生的嘱托</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/06/25/LeetCode-189-旋转数组/">LeetCode-189-旋转数组</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/06/25/LeetCode-122-买卖股票的最佳时机 II/">LeetCode-122-买卖股票的最佳时机 II</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/06/25/LeetCode-26-删除数组中的重复元素/">LeetCode-26-删除数组中的重复元素</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/05/15/我是如何看待工作的/">我是如何看待工作的</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/01/01/与青春有关的日子/">观《与青春有关的日子》</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/12/27/redux-middleware/">Redux 中间件机制探底</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/12/27/redux-and-react-redux/">状态管理之 Redux & React Redux</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2021 <a href="/." rel="nofollow">李茶德的日记.</a><a rel="nofollow" target="_blank" href="http://www.beian.miit.gov.cn"> 京ICP备17057625号.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>