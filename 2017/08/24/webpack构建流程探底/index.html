<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="记录学习、工作、生活"><title>webpack构建流程探底 | 我的日记本</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/img/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">webpack构建流程探底</h1><a id="logo" href="/.">我的日记本</a><p class="description">记录学习、工作、生活</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa null"> 首页</i></a><a href="/archives/"><i class="fa null"> 归档</i></a><a href="/about/"><i class="fa null"> 关于</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">webpack构建流程探底</h1><div class="post-meta">2017-08-24<span> | </span><span class="category"><a href="/categories/前端/">前端</a></span></div><div class="post-content"><p>本文旨在搞清楚从命令行下敲下 <code>webpack</code> 命令，或者配置 <code>npm script</code> 后执行 <code>package.json</code> 中的命令，到工程目录下出现打包的后的 <code>bundle</code> 文件的过程中，webpack都替我们做了哪些工作。</p>
<a id="more"></a>
<p>测试用webpack版本为 <a href="mailto:**webpack@3.4.1" target="_blank" rel="noopener">**webpack@3.4.1</a>**</p>
<p>webpack.config.js中定义好相关配置，包括 <code>entry</code>、<code>output</code>、<code>module</code>、<code>plugins</code>等，命令行执行 webpack 命令，webpack 便会根据配置文件中的配置进行打包处理文件，并生成最后打包后的文件。</p>
<h4 id="第一步：执行-webpack-命令时，发生了什么？-bin-webpack-js"><a href="#第一步：执行-webpack-命令时，发生了什么？-bin-webpack-js" class="headerlink" title="第一步：执行 webpack 命令时，发生了什么？(bin/webpack.js)"></a>第一步：执行 webpack 命令时，发生了什么？(bin/webpack.js)</h4><p>命令行执行 webpack 时，如果全局命令行中未找到webpack命令的话，执行本地的node-modules/bin/webpack.js 文件。</p>
<p>在bin/webpack.js中使用 <strong>yargs库</strong> 解析了命令行的参数，处理了 webpack 的配置对象 options，调用 <code>processOptions()</code> 函数。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 处理编译相关，核心函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">processOptions</span>(<span class="params">options</span>) </span>&#123;</span><br><span class="line">	<span class="comment">// promise风格的处理，暂时还没遇到这种情况的配置</span></span><br><span class="line">	<span class="keyword">if</span>(<span class="keyword">typeof</span> options.then === <span class="string">"function"</span>) &#123;...&#125;   </span><br><span class="line">    <span class="comment">// 处理传入的options为数组的情况</span></span><br><span class="line">	<span class="keyword">var</span> firstOptions = [].concat(options)[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> statsPresetToOptions = <span class="built_in">require</span>(<span class="string">"../lib/Stats.js"</span>).presetToOptions;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置输出的options</span></span><br><span class="line">	<span class="keyword">var</span> outputOptions = options.stats;</span><br><span class="line">	<span class="keyword">if</span>(<span class="keyword">typeof</span> outputOptions === <span class="string">"boolean"</span> || <span class="keyword">typeof</span> outputOptions === <span class="string">"string"</span>) &#123;</span><br><span class="line">		outputOptions = statsPresetToOptions(outputOptions);</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span>(!outputOptions) &#123;</span><br><span class="line">		outputOptions = &#123;&#125;;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// 处理各种现实相关的参数</span></span><br><span class="line">	ifArg(<span class="string">"display"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">preset</span>) </span>&#123;</span><br><span class="line">		outputOptions = statsPresetToOptions(preset);</span><br><span class="line">	&#125;);</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 引入lib下的webpack.js,入口文件</span></span><br><span class="line">	<span class="keyword">var</span> webpack = <span class="built_in">require</span>(<span class="string">"../lib/webpack.js"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置最大错误追踪堆栈</span></span><br><span class="line">	<span class="built_in">Error</span>.stackTraceLimit = <span class="number">30</span>;</span><br><span class="line">	<span class="keyword">var</span> lastHash = <span class="literal">null</span>;</span><br><span class="line">	<span class="keyword">var</span> compiler;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 编译，这里是关键，需要进入lib/webpack.js文件查看</span></span><br><span class="line">		compiler = webpack(options);</span><br><span class="line">	&#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">        <span class="comment">// 错误处理</span></span><br><span class="line">		<span class="keyword">var</span> WebpackOptionsValidationError = <span class="built_in">require</span>(<span class="string">"../lib/WebpackOptionsValidationError"</span>);</span><br><span class="line">		<span class="keyword">if</span>(e <span class="keyword">instanceof</span> WebpackOptionsValidationError) &#123;</span><br><span class="line">			<span class="keyword">if</span>(argv.color)</span><br><span class="line">				<span class="built_in">console</span>.error(<span class="string">"\u001b[1m\u001b[31m"</span> + e.message + <span class="string">"\u001b[39m\u001b[22m"</span>);</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">				<span class="built_in">console</span>.error(e.message);</span><br><span class="line">			process.exit(<span class="number">1</span>); <span class="comment">// eslint-disable-line no-process-exit</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">throw</span> e;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// 显示相关参数处理</span></span><br><span class="line">	<span class="keyword">if</span>(argv.progress) &#123;</span><br><span class="line">		<span class="keyword">var</span> ProgressPlugin = <span class="built_in">require</span>(<span class="string">"../lib/ProgressPlugin"</span>);</span><br><span class="line">		compiler.apply(<span class="keyword">new</span> ProgressPlugin(&#123;</span><br><span class="line">			profile: argv.profile</span><br><span class="line">		&#125;));</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// 编译完后的回调函数</span></span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">compilerCallback</span>(<span class="params">err, stats</span>) </span>&#123;&#125;</span><br><span class="line">    <span class="comment">// watch模式下的处理</span></span><br><span class="line">	<span class="keyword">if</span>(firstOptions.watch || options.watch) &#123;</span><br><span class="line">		<span class="keyword">var</span> watchOptions = firstOptions.watchOptions || firstOptions.watch || options.watch || &#123;&#125;;</span><br><span class="line">		<span class="keyword">if</span>(watchOptions.stdin) &#123;</span><br><span class="line">			process.stdin.on(<span class="string">"end"</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">				process.exit(<span class="number">0</span>); <span class="comment">// eslint-disable-line</span></span><br><span class="line">			&#125;);</span><br><span class="line">			process.stdin.resume();</span><br><span class="line">		&#125;</span><br><span class="line">		compiler.watch(watchOptions, compilerCallback);</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">"\nWebpack is watching the files…\n"</span>);</span><br><span class="line">	&#125; <span class="keyword">else</span></span><br><span class="line">    <span class="comment">// 调用run()函数，正式进入编译过程</span></span><br><span class="line">		compiler.run(compilerCallback);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="第二步：-调用-webpack，返回-compiler-对象的过程（lib-webpack-js）"><a href="#第二步：-调用-webpack，返回-compiler-对象的过程（lib-webpack-js）" class="headerlink" title="第二步： 调用 webpack，返回 compiler 对象的过程（lib/webpack.js）"></a>第二步： 调用 webpack，返回 compiler 对象的过程（lib/webpack.js）</h4><p>如下图所示，lib/webpack.js 中的关键函数为 webpack，其中定义了编译相关的一些操作。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">"use strict"</span>;</span><br><span class="line"><span class="keyword">const</span> Compiler = <span class="built_in">require</span>(<span class="string">"./Compiler"</span>);</span><br><span class="line"><span class="keyword">const</span> MultiCompiler = <span class="built_in">require</span>(<span class="string">"./MultiCompiler"</span>);</span><br><span class="line"><span class="keyword">const</span> NodeEnvironmentPlugin = <span class="built_in">require</span>(<span class="string">"./node/NodeEnvironmentPlugin"</span>);</span><br><span class="line"><span class="keyword">const</span> WebpackOptionsApply = <span class="built_in">require</span>(<span class="string">"./WebpackOptionsApply"</span>);</span><br><span class="line"><span class="keyword">const</span> WebpackOptionsDefaulter = <span class="built_in">require</span>(<span class="string">"./WebpackOptionsDefaulter"</span>);</span><br><span class="line"><span class="keyword">const</span> validateSchema = <span class="built_in">require</span>(<span class="string">"./validateSchema"</span>);</span><br><span class="line"><span class="keyword">const</span> WebpackOptionsValidationError = <span class="built_in">require</span>(<span class="string">"./WebpackOptionsValidationError"</span>);</span><br><span class="line"><span class="keyword">const</span> webpackOptionsSchema = <span class="built_in">require</span>(<span class="string">"../schemas/webpackOptionsSchema.json"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 核心方法，调用该方法，返回Compiler的实例对象compiler</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">webpack</span>(<span class="params">options, callback</span>) </span>&#123;...&#125;</span><br><span class="line">exports = <span class="built_in">module</span>.exports = webpack;</span><br><span class="line"><span class="comment">// 设置webpack对象的常用属性</span></span><br><span class="line">webpack.WebpackOptionsDefaulter = WebpackOptionsDefaulter;</span><br><span class="line">webpack.WebpackOptionsApply = WebpackOptionsApply;</span><br><span class="line">webpack.Compiler = Compiler;</span><br><span class="line">webpack.MultiCompiler = MultiCompiler;</span><br><span class="line">webpack.NodeEnvironmentPlugin = NodeEnvironmentPlugin;</span><br><span class="line">webpack.validate = validateSchema.bind(<span class="keyword">this</span>, webpackOptionsSchema);</span><br><span class="line">webpack.validateSchema = validateSchema;</span><br><span class="line">webpack.WebpackOptionsValidationError = WebpackOptionsValidationError;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 对外暴露一些插件</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">exportPlugins</span>(<span class="params">obj, mappings</span>) </span>&#123;...&#125;</span><br><span class="line"></span><br><span class="line">exportPlugins(exports, &#123;...&#125;);</span><br><span class="line">exportPlugins(exports.optimize = &#123;&#125;, &#123;...&#125;);</span><br></pre></td></tr></table></figure>
<p>接下来看在webpack函数中主要定义了哪些操作<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 核心方法，调用该方法，返回Compiler的实例对象compiler</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">webpack</span>(<span class="params">options, callback</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 验证是否符合格式</span></span><br><span class="line">	<span class="keyword">const</span> webpackOptionsValidationErrors = validateSchema(webpackOptionsSchema, options);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(webpackOptionsValidationErrors.length) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> WebpackOptionsValidationError(webpackOptionsValidationErrors);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">let</span> compiler;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 传入的options为数组的情况，调用MultiCompiler进行处理，目前还没遇到过这种情况的配置</span></span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">Array</span>.isArray(options)) &#123;</span><br><span class="line">		compiler = <span class="keyword">new</span> MultiCompiler(options.map(<span class="function"><span class="params">options</span> =&gt;</span> webpack(options)));</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">typeof</span> options === <span class="string">"object"</span>) &#123;</span><br><span class="line">		<span class="comment">// 配置options的默认参数</span></span><br><span class="line">		<span class="keyword">new</span> WebpackOptionsDefaulter().process(options);</span><br><span class="line">		<span class="comment">// 初始化一个Compiler的实例</span></span><br><span class="line">		compiler = <span class="keyword">new</span> Compiler();</span><br><span class="line">		<span class="comment">// 设置context的默认值为进程的当前目录，绝对路径</span></span><br><span class="line">		compiler.context = options.context;</span><br><span class="line">		<span class="comment">// 定义compiler的options属性</span></span><br><span class="line">		compiler.options = options;</span><br><span class="line">		<span class="comment">// Node环境插件，其中设置compiler的inputFileSystem,outputFileSystem,watchFileSystem,并定义了before-run的钩子函数</span></span><br><span class="line">		<span class="keyword">new</span> NodeEnvironmentPlugin().apply(compiler);</span><br><span class="line">		<span class="comment">// 应用每个插件</span></span><br><span class="line">		<span class="keyword">if</span>(options.plugins &amp;&amp; <span class="built_in">Array</span>.isArray(options.plugins)) &#123;</span><br><span class="line">			compiler.apply.apply(compiler, options.plugins);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 调用environment插件</span></span><br><span class="line">		compiler.applyPlugins(<span class="string">"environment"</span>);</span><br><span class="line">		<span class="comment">// 调用after-environment插件</span></span><br><span class="line">		compiler.applyPlugins(<span class="string">"after-environment"</span>);</span><br><span class="line">		<span class="comment">// 处理compiler对象，调用一些必备插件</span></span><br><span class="line">		compiler.options = <span class="keyword">new</span> WebpackOptionsApply().process(options, compiler);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Invalid argument: options"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(callback) &#123;</span><br><span class="line">		<span class="keyword">if</span>(<span class="keyword">typeof</span> callback !== <span class="string">"function"</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Invalid argument: callback"</span>);</span><br><span class="line">		<span class="keyword">if</span>(options.watch === <span class="literal">true</span> || (<span class="built_in">Array</span>.isArray(options) &amp;&amp; options.some(<span class="function"><span class="params">o</span> =&gt;</span> o.watch))) &#123;</span><br><span class="line">			<span class="keyword">const</span> watchOptions = <span class="built_in">Array</span>.isArray(options) ? options.map(<span class="function"><span class="params">o</span> =&gt;</span> o.watchOptions || &#123;&#125;) : (options.watchOptions || &#123;&#125;);</span><br><span class="line">			<span class="keyword">return</span> compiler.watch(watchOptions, callback);</span><br><span class="line">		&#125;</span><br><span class="line">		compiler.run(callback);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> compiler;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>webpack函数中主要做了以下两个操作，</p>
<ul>
<li><p>实例化 Compiler 类。该类继承自 Tapable 类，Tapable 是一个基于发布订阅的插件架构。webpack 便是基于Tapable的发布订阅模式实现的整个流程。Tapable 中通过 plugins 注册插件名，以及对应的回调函数，通过 <code>apply</code>,<code>applyPlugins</code>,<code>applyPluginsWater</code>,<code>applyPluginsAsync</code>等函数以不同的方式调用注册在某一插件下的回调。</p>
</li>
<li><p>通过WebpackOptionsApply 处理webpack compiler对象，通过 compiler.apply的方式调用了一些必备插件，在这些插件中，注册了一些 plugins，在后面的编译过程中，通过调用一些插件的方式，去处理一些流程。</p>
</li>
</ul>
<h4 id="第三步：调用compiler的run的过程-Compiler-js"><a href="#第三步：调用compiler的run的过程-Compiler-js" class="headerlink" title="第三步：调用compiler的run的过程(Compiler.js)"></a>第三步：调用compiler的run的过程(Compiler.js)</h4><ul>
<li><code>run()</code>调用</li>
</ul>
<p>run函数中主要触发了before-run事件，在before-run事件的回调函数中触发了run事件，run事件中调用了readRecord函数读取文件，并调用compile()函数进行编译。</p>
<ul>
<li><code>compile()</code>调用</li>
</ul>
<p>compile函数中定义了编译的相关流程，主要有以下流程：</p>
<ul>
<li>创建编译参数</li>
<li>触发 <code>before-compile</code> 事件，</li>
<li>触发 <code>compile</code> 事件,开始编译</li>
<li>创建 <code>compilation</code>对象，负责整个编译过程中具体细节的对象</li>
<li>触发 <code>make</code> 事件，开始创建模块和分析其依赖</li>
<li>根据入口配置的类型，决定是调用哪个plugin中的 <code>make</code> 事件的回调。如单入口的 <code>entry</code>，调用的是SingleEntryPlugin.js下 <code>make</code> 事件注册的回调函数，其他多入口同理。</li>
<li>调用 <code>compilation</code> 对象的 <code>addEntry</code> 函数，创建模块以及依赖。</li>
<li><code>make</code> 事件的回调函数中，通过<code>seal</code> 封装构建的结果</li>
<li><code>run</code> 方法中定义的 <code>onCompiled</code>回调函数被调用，完成emit过程，将结果写入至目标文件</li>
</ul>
<p>compile函数的定义</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">compile(callback) &#123;</span><br><span class="line">    <span class="comment">// 创建编译参数，包括模块工厂和编译依赖参数数组</span></span><br><span class="line">	<span class="keyword">const</span> params = <span class="keyword">this</span>.newCompilationParams();</span><br><span class="line">	<span class="comment">// 触发before-compile 事件，开始整个编译过程</span></span><br><span class="line">	<span class="keyword">this</span>.applyPluginsAsync(<span class="string">"before-compile"</span>, params, err =&gt; &#123;</span><br><span class="line">		<span class="keyword">if</span>(err) <span class="keyword">return</span> callback(err);</span><br><span class="line">		<span class="comment">// 触发compile事件</span></span><br><span class="line">		<span class="keyword">this</span>.applyPlugins(<span class="string">"compile"</span>, params);</span><br><span class="line">		<span class="comment">// 构建compilation对象，compilation对象负责具体的编译细节</span></span><br><span class="line">		<span class="keyword">const</span> compilation = <span class="keyword">this</span>.newCompilation(params);</span><br><span class="line">        <span class="comment">// 触发make事件,对应的监听make事件的回调函数在不同的EntryPlugin中注册，比如singleEntryPlugin</span></span><br><span class="line">		<span class="keyword">this</span>.applyPluginsParallel(<span class="string">"make"</span>, compilation, err =&gt; &#123;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span>(err) <span class="keyword">return</span> callback(err);</span><br><span class="line"></span><br><span class="line">			compilation.finish();</span><br><span class="line"></span><br><span class="line">			compilation.seal(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">				<span class="keyword">if</span>(err) <span class="keyword">return</span> callback(err);</span><br><span class="line"></span><br><span class="line">				<span class="keyword">this</span>.applyPluginsAsync(<span class="string">"after-compile"</span>, compilation, err =&gt; &#123;</span><br><span class="line">					<span class="keyword">if</span>(err) <span class="keyword">return</span> callback(err);</span><br><span class="line">					<span class="keyword">return</span> callback(<span class="literal">null</span>, compilation);</span><br><span class="line">				&#125;);</span><br><span class="line">			&#125;);</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>【问题】<code>make</code> 事件触发后，有哪些插件中注册了make事件并得到了运行的机会呢？</p>
<p>以单入口entry配置为例，在EntryOptionPlugin插件中定义了，不同配置的入口应该调用何种插件进行解析。不同配置的入口插件中注册了对应的 <code>make</code> 事件回调函数，在make事件触发后被调用。</p>
<p>如下所示：</p>
<p><strong>一个插件的<code>apply</code>方法是一个插件的核心方法，当说一个插件被调用时主要是其apply方法被调用。</strong></p>
<p>EntryOptionPlugin 插件在webpackOptionsApply中被调用，其内部定义了使用何种插件来解析入口文件。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> SingleEntryPlugin = <span class="built_in">require</span>(<span class="string">"./SingleEntryPlugin"</span>);</span><br><span class="line"><span class="keyword">const</span> MultiEntryPlugin = <span class="built_in">require</span>(<span class="string">"./MultiEntryPlugin"</span>);</span><br><span class="line"><span class="keyword">const</span> DynamicEntryPlugin = <span class="built_in">require</span>(<span class="string">"./DynamicEntryPlugin"</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="class"><span class="keyword">class</span> <span class="title">EntryOptionPlugin</span> </span>&#123;</span><br><span class="line">	apply(compiler) &#123;</span><br><span class="line">		compiler.plugin(<span class="string">"entry-option"</span>, (context, entry) =&gt; &#123;</span><br><span class="line">			<span class="function"><span class="keyword">function</span> <span class="title">itemToPlugin</span>(<span class="params">item, name</span>) </span>&#123;</span><br><span class="line">				<span class="keyword">if</span>(<span class="built_in">Array</span>.isArray(item)) &#123;</span><br><span class="line">					<span class="keyword">return</span> <span class="keyword">new</span> MultiEntryPlugin(context, item, name);</span><br><span class="line">				&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					<span class="keyword">return</span> <span class="keyword">new</span> SingleEntryPlugin(context, item, name);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// 判断entry字段的类型去调用不同的入口插件去处理</span></span><br><span class="line">			<span class="keyword">if</span>(<span class="keyword">typeof</span> entry === <span class="string">"string"</span> || <span class="built_in">Array</span>.isArray(entry)) &#123;</span><br><span class="line">				compiler.apply(itemToPlugin(entry, <span class="string">"main"</span>));</span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">typeof</span> entry === <span class="string">"object"</span>) &#123;</span><br><span class="line">				<span class="built_in">Object</span>.keys(entry).forEach(<span class="function"><span class="params">name</span> =&gt;</span> compiler.apply(itemToPlugin(entry[name], name)));</span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">typeof</span> entry === <span class="string">"function"</span>) &#123;</span><br><span class="line">				compiler.apply(<span class="keyword">new</span> DynamicEntryPlugin(context, entry));</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>entry-option</code> 事件被触发时，EntryOptionPlugin 插件做了这几个事情：</p>
<ul>
<li>判断入口的类型，通过 <code>entry</code> 字段来判断，对应了 <code>entry</code> 字段为 <code>string</code> <code>object</code> <code>function</code>的三种情况</li>
<li><p>每种不同的类型调用不同的插件去处理入口的配置。大致处理逻辑如下：</p>
<ul>
<li>数组类型的entry调用multiEntryPlugin插件去处理，对应了多入口的场景</li>
<li>function的entry调用了DynamicEntryPlugin插件去处理，对应了异步chunk的场景</li>
<li>string类型的entry或者object类型的entry，调用SingleEntryPlugin去处理，对应了单入口的场景</li>
</ul>
</li>
</ul>
<p>【问题】<code>entry-option</code> 事件是在什么时机被触发的呢？</p>
<p>如下代码所示，是在WebpackOptionsApply.js中，先调用处理入口的EntryOptionPlugin插件，然后触发 <code>entry-option</code> 事件，去调用不同类型的入口处理插件。</p>
<p><strong>注意：调用插件的过程也就是一个注册事件以及回调函数的过程。</strong></p>
<p>WebpackOptionApply.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 调用处理入口entry的插件</span></span><br><span class="line">compiler.apply(<span class="keyword">new</span> EntryOptionPlugin());</span><br><span class="line">compiler.applyPluginsBailResult(<span class="string">"entry-option"</span>, options.context, options.entry);</span><br></pre></td></tr></table></figure></p>
<p>前面说到，make事件触发时，对应的回调逻辑都在不同配置入口的插件中注册的。下面以SingleEntryPlugin为例，说明从 <code>make</code> 事件被触发，到编译结束的整个过程。</p>
<p>SingleEntryPlugin.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SingleEntryPlugin</span> </span>&#123;</span><br><span class="line">	<span class="keyword">constructor</span>(context, entry, name) &#123;</span><br><span class="line">		<span class="keyword">this</span>.context = context;</span><br><span class="line">		<span class="keyword">this</span>.entry = entry;</span><br><span class="line">		<span class="keyword">this</span>.name = name;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	apply(compiler) &#123;</span><br><span class="line">	    <span class="comment">// compilation 事件在初始化Compilation对象的时候被触发</span></span><br><span class="line">		compiler.plugin(<span class="string">"compilation"</span>, (compilation, params) =&gt; &#123;</span><br><span class="line">			<span class="keyword">const</span> normalModuleFactory = params.normalModuleFactory;</span><br><span class="line">			compilation.dependencyFactories.set(SingleEntryDependency, normalModuleFactory);</span><br><span class="line">		&#125;);</span><br><span class="line">        <span class="comment">// make 事件在执行compile的时候被触发</span></span><br><span class="line">		compiler.plugin(<span class="string">"make"</span>, (compilation, callback) =&gt; &#123;</span><br><span class="line">			<span class="keyword">const</span> dep = SingleEntryPlugin.createDependency(<span class="keyword">this</span>.entry, <span class="keyword">this</span>.name);</span><br><span class="line">			<span class="comment">// 编译的关键，调用Compilation中的addEntry，添加入口，进入编译过程。</span></span><br><span class="line">			compilation.addEntry(<span class="keyword">this</span>.context, dep, <span class="keyword">this</span>.name, callback);</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">static</span> createDependency(entry, name) &#123;</span><br><span class="line">		<span class="keyword">const</span> dep = <span class="keyword">new</span> SingleEntryDependency(entry);</span><br><span class="line">		dep.loc = name;</span><br><span class="line">		<span class="keyword">return</span> dep;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = SingleEntryPlugin;</span><br></pre></td></tr></table></figure>
<p>Compilation中负责具体编译的细节，包括如何创建模块以及模块的依赖，根据模板生成js等。如：<code>addEntry</code>,<code>buildModule</code>, <code>processModuleDependencies</code>等。</p>
<p>Compilation.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">addEntry(context, entry, name, callback) &#123;</span><br><span class="line">	<span class="keyword">const</span> slot = &#123;</span><br><span class="line">		name: name,</span><br><span class="line">		<span class="built_in">module</span>: <span class="literal">null</span></span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="keyword">this</span>.preparedChunks.push(slot);</span><br><span class="line">	<span class="comment">// 添加该chunk上的module依赖</span></span><br><span class="line">	<span class="keyword">this</span>._addModuleChain(context, entry, (<span class="built_in">module</span>) =&gt; &#123;</span><br><span class="line">		entry.module = <span class="built_in">module</span>;</span><br><span class="line">		<span class="keyword">this</span>.entries.push(<span class="built_in">module</span>);</span><br><span class="line">		<span class="built_in">module</span>.issuer = <span class="literal">null</span>;</span><br><span class="line">	&#125;, (err, <span class="built_in">module</span>) =&gt; &#123;</span><br><span class="line">		<span class="keyword">if</span>(err) &#123;</span><br><span class="line">			<span class="keyword">return</span> callback(err);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(<span class="built_in">module</span>) &#123;</span><br><span class="line">			slot.module = <span class="built_in">module</span>;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">const</span> idx = <span class="keyword">this</span>.preparedChunks.indexOf(slot);</span><br><span class="line">			<span class="keyword">this</span>.preparedChunks.splice(idx, <span class="number">1</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> callback(<span class="literal">null</span>, <span class="built_in">module</span>);</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">_addModuleChain(context, dependency, onModule, callback) &#123;</span><br><span class="line">	<span class="keyword">const</span> start = <span class="keyword">this</span>.profile &amp;&amp; <span class="built_in">Date</span>.now();</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 根据模块的类型获取对应的模块工厂并创建模块</span></span><br><span class="line">	<span class="keyword">const</span> moduleFactory = <span class="keyword">this</span>.dependencyFactories.get(dependency.constructor);</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 创建模块，将创建好的模块module作为参数传递给回调函数</span></span><br><span class="line">	moduleFactory.create(&#123;</span><br><span class="line">		contextInfo: &#123;</span><br><span class="line">			issuer: <span class="string">""</span>,</span><br><span class="line">			compiler: <span class="keyword">this</span>.compiler.name</span><br><span class="line">		&#125;,</span><br><span class="line">		context: context,</span><br><span class="line">		dependencies: [dependency]</span><br><span class="line">	&#125;, (err, <span class="built_in">module</span>) =&gt; &#123;</span><br><span class="line">		<span class="keyword">if</span>(err) &#123;</span><br><span class="line">			<span class="keyword">return</span> errorAndCallback(<span class="keyword">new</span> EntryModuleNotFoundError(err));</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">let</span> afterFactory;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(<span class="keyword">this</span>.profile) &#123;</span><br><span class="line">			<span class="keyword">if</span>(!<span class="built_in">module</span>.profile) &#123;</span><br><span class="line">				<span class="built_in">module</span>.profile = &#123;&#125;;</span><br><span class="line">			&#125;</span><br><span class="line">			afterFactory = <span class="built_in">Date</span>.now();</span><br><span class="line">			<span class="built_in">module</span>.profile.factory = afterFactory - start;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">const</span> result = <span class="keyword">this</span>.addModule(<span class="built_in">module</span>);</span><br><span class="line">		<span class="keyword">if</span>(!result) &#123;</span><br><span class="line">			<span class="built_in">module</span> = <span class="keyword">this</span>.getModule(<span class="built_in">module</span>);</span><br><span class="line"></span><br><span class="line">			onModule(<span class="built_in">module</span>);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span>(<span class="keyword">this</span>.profile) &#123;</span><br><span class="line">				<span class="keyword">const</span> afterBuilding = <span class="built_in">Date</span>.now();</span><br><span class="line">				<span class="built_in">module</span>.profile.building = afterBuilding - afterFactory;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">return</span> callback(<span class="literal">null</span>, <span class="built_in">module</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(result <span class="keyword">instanceof</span> Module) &#123;</span><br><span class="line">			<span class="keyword">if</span>(<span class="keyword">this</span>.profile) &#123;</span><br><span class="line">				result.profile = <span class="built_in">module</span>.profile;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="built_in">module</span> = result;</span><br><span class="line">			onModule(<span class="built_in">module</span>);</span><br><span class="line">			moduleReady.call(<span class="keyword">this</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		onModule(<span class="built_in">module</span>);</span><br><span class="line">		<span class="comment">// 构建模块，包括调用loader处理文件，使用acorn生成AST，遍历AST收集依赖</span></span><br><span class="line">		<span class="keyword">this</span>.buildModule(<span class="built_in">module</span>, <span class="literal">false</span>, <span class="literal">null</span>, <span class="literal">null</span>, (err) =&gt; &#123;</span><br><span class="line">			<span class="keyword">if</span>(err) &#123;</span><br><span class="line">				<span class="keyword">return</span> errorAndCallback(err);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span>(<span class="keyword">this</span>.profile) &#123;</span><br><span class="line">				<span class="keyword">const</span> afterBuilding = <span class="built_in">Date</span>.now();</span><br><span class="line">				<span class="built_in">module</span>.profile.building = afterBuilding - afterFactory;</span><br><span class="line">			&#125;</span><br><span class="line">            <span class="comment">// 开始处理收集好的依赖</span></span><br><span class="line">			moduleReady.call(<span class="keyword">this</span>);</span><br><span class="line">		&#125;);</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">function</span> <span class="title">moduleReady</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">			<span class="keyword">this</span>.processModuleDependencies(<span class="built_in">module</span>, err =&gt; &#123;</span><br><span class="line">				<span class="keyword">if</span>(err) &#123;</span><br><span class="line">					<span class="keyword">return</span> callback(err);</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="keyword">return</span> callback(<span class="literal">null</span>, <span class="built_in">module</span>);</span><br><span class="line">			&#125;);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>_addModuleChain</code> 主要做了以下几件事情：</p>
<ul>
<li>调用对应的模块工厂类去创建module</li>
<li><code>buildModule</code>,开始构建模块，收集依赖。构建过程中最耗时的一步，主要完成了调用loader处理模块以及模块之间的依赖，使用acorn生成AST的过程，遍历AST循环收集并构建依赖模块的过程。此处可以深入了解webpack使用loader处理模块的原理。</li>
</ul>
<h4 id="第四步：模块build完成后，使用seal进行module和chunk的一些处理，包括合并、拆分等。"><a href="#第四步：模块build完成后，使用seal进行module和chunk的一些处理，包括合并、拆分等。" class="headerlink" title="第四步：模块build完成后，使用seal进行module和chunk的一些处理，包括合并、拆分等。"></a>第四步：模块build完成后，使用seal进行module和chunk的一些处理，包括合并、拆分等。</h4><p>Compilation的 <code>seal</code> 函数在 <code>make</code> 事件的回调函数中进行了调用。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line">seal(callback) &#123;</span><br><span class="line">	<span class="keyword">const</span> self = <span class="keyword">this</span>;</span><br><span class="line">	<span class="comment">// 触发seal事件，提供其他插件中seal的执行时机</span></span><br><span class="line">	self.applyPlugins0(<span class="string">"seal"</span>);</span><br><span class="line">	self.nextFreeModuleIndex = <span class="number">0</span>;</span><br><span class="line">	self.nextFreeModuleIndex2 = <span class="number">0</span>;</span><br><span class="line">	self.preparedChunks.forEach(<span class="function"><span class="params">preparedChunk</span> =&gt;</span> &#123;</span><br><span class="line">		<span class="keyword">const</span> <span class="built_in">module</span> = preparedChunk.module;</span><br><span class="line">		<span class="comment">// 将module保存在chunk的origins中，origins保存了module的信息</span></span><br><span class="line">		<span class="keyword">const</span> chunk = self.addChunk(preparedChunk.name, <span class="built_in">module</span>);</span><br><span class="line">		<span class="comment">// 创建一个entrypoint</span></span><br><span class="line">		<span class="keyword">const</span> entrypoint = self.entrypoints[chunk.name] = <span class="keyword">new</span> Entrypoint(chunk.name);</span><br><span class="line">		<span class="comment">// 将chunk创建的chunk保存在entrypoint中，并将该entrypoint的实例保存在chunk的entrypoints中</span></span><br><span class="line">		entrypoint.unshiftChunk(chunk);</span><br><span class="line">		<span class="comment">// 将module保存在chunk的_modules数组中</span></span><br><span class="line">		chunk.addModule(<span class="built_in">module</span>);</span><br><span class="line">		<span class="comment">// module实例上记录chunk的信息</span></span><br><span class="line">		<span class="built_in">module</span>.addChunk(chunk);</span><br><span class="line">		<span class="comment">// 定义该chunk的entryModule属性</span></span><br><span class="line">		chunk.entryModule = <span class="built_in">module</span>;</span><br><span class="line">		self.assignIndex(<span class="built_in">module</span>);</span><br><span class="line">		self.assignDepth(<span class="built_in">module</span>);</span><br><span class="line">		self.processDependenciesBlockForChunk(<span class="built_in">module</span>, chunk);</span><br><span class="line">	&#125;);</span><br><span class="line">	self.sortModules(self.modules);</span><br><span class="line">	self.applyPlugins0(<span class="string">"optimize"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span>(self.applyPluginsBailResult1(<span class="string">"optimize-modules-basic"</span>, self.modules) ||</span><br><span class="line">		self.applyPluginsBailResult1(<span class="string">"optimize-modules"</span>, self.modules) ||</span><br><span class="line">		self.applyPluginsBailResult1(<span class="string">"optimize-modules-advanced"</span>, self.modules)) &#123; <span class="comment">/* empty */</span> &#125;</span><br><span class="line">	self.applyPlugins1(<span class="string">"after-optimize-modules"</span>, self.modules);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span>(self.applyPluginsBailResult1(<span class="string">"optimize-chunks-basic"</span>, self.chunks) ||</span><br><span class="line">		self.applyPluginsBailResult1(<span class="string">"optimize-chunks"</span>, self.chunks) ||</span><br><span class="line">		self.applyPluginsBailResult1(<span class="string">"optimize-chunks-advanced"</span>, self.chunks)) &#123; <span class="comment">/* empty */</span> &#125;</span><br><span class="line">	self.applyPlugins1(<span class="string">"after-optimize-chunks"</span>, self.chunks);</span><br><span class="line"></span><br><span class="line">	self.applyPluginsAsyncSeries(<span class="string">"optimize-tree"</span>, self.chunks, self.modules, <span class="function"><span class="keyword">function</span> <span class="title">sealPart2</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(err) &#123;</span><br><span class="line">			<span class="keyword">return</span> callback(err);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		self.applyPlugins2(<span class="string">"after-optimize-tree"</span>, self.chunks, self.modules);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">while</span>(self.applyPluginsBailResult(<span class="string">"optimize-chunk-modules-basic"</span>, self.chunks, self.modules) ||</span><br><span class="line">			self.applyPluginsBailResult(<span class="string">"optimize-chunk-modules"</span>, self.chunks, self.modules) ||</span><br><span class="line">			self.applyPluginsBailResult(<span class="string">"optimize-chunk-modules-advanced"</span>, self.chunks, self.modules)) &#123; <span class="comment">/* empty */</span> &#125;</span><br><span class="line">		self.applyPlugins2(<span class="string">"after-optimize-chunk-modules"</span>, self.chunks, self.modules);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">const</span> shouldRecord = self.applyPluginsBailResult(<span class="string">"should-record"</span>) !== <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">		self.applyPlugins2(<span class="string">"revive-modules"</span>, self.modules, self.records);</span><br><span class="line">		self.applyPlugins1(<span class="string">"optimize-module-order"</span>, self.modules);</span><br><span class="line">		self.applyPlugins1(<span class="string">"advanced-optimize-module-order"</span>, self.modules);</span><br><span class="line">		self.applyPlugins1(<span class="string">"before-module-ids"</span>, self.modules);</span><br><span class="line">		self.applyPlugins1(<span class="string">"module-ids"</span>, self.modules);</span><br><span class="line">		self.applyModuleIds();</span><br><span class="line">		self.applyPlugins1(<span class="string">"optimize-module-ids"</span>, self.modules);</span><br><span class="line">		self.applyPlugins1(<span class="string">"after-optimize-module-ids"</span>, self.modules);</span><br><span class="line"></span><br><span class="line">		self.sortItemsWithModuleIds();</span><br><span class="line"></span><br><span class="line">		self.applyPlugins2(<span class="string">"revive-chunks"</span>, self.chunks, self.records);</span><br><span class="line">		self.applyPlugins1(<span class="string">"optimize-chunk-order"</span>, self.chunks);</span><br><span class="line">		self.applyPlugins1(<span class="string">"before-chunk-ids"</span>, self.chunks);</span><br><span class="line">		self.applyChunkIds();</span><br><span class="line">		self.applyPlugins1(<span class="string">"optimize-chunk-ids"</span>, self.chunks);</span><br><span class="line">		self.applyPlugins1(<span class="string">"after-optimize-chunk-ids"</span>, self.chunks);</span><br><span class="line"></span><br><span class="line">		self.sortItemsWithChunkIds();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(shouldRecord)</span><br><span class="line">			self.applyPlugins2(<span class="string">"record-modules"</span>, self.modules, self.records);</span><br><span class="line">		<span class="keyword">if</span>(shouldRecord)</span><br><span class="line">			self.applyPlugins2(<span class="string">"record-chunks"</span>, self.chunks, self.records);</span><br><span class="line"></span><br><span class="line">		self.applyPlugins0(<span class="string">"before-hash"</span>);</span><br><span class="line">		<span class="comment">// 创建hash</span></span><br><span class="line">		self.createHash();</span><br><span class="line">		self.applyPlugins0(<span class="string">"after-hash"</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(shouldRecord)</span><br><span class="line">			self.applyPlugins1(<span class="string">"record-hash"</span>, self.records);</span><br><span class="line"></span><br><span class="line">		self.applyPlugins0(<span class="string">"before-module-assets"</span>);</span><br><span class="line">		self.createModuleAssets();</span><br><span class="line">		<span class="keyword">if</span>(self.applyPluginsBailResult(<span class="string">"should-generate-chunk-assets"</span>) !== <span class="literal">false</span>) &#123;</span><br><span class="line">			self.applyPlugins0(<span class="string">"before-chunk-assets"</span>);</span><br><span class="line">			<span class="comment">// 使用template创建最后的js代码</span></span><br><span class="line">			self.createChunkAssets();</span><br><span class="line">		&#125;</span><br><span class="line">		self.applyPlugins1(<span class="string">"additional-chunk-assets"</span>, self.chunks);</span><br><span class="line">		self.summarizeDependencies();</span><br><span class="line">		<span class="keyword">if</span>(shouldRecord)</span><br><span class="line">			self.applyPlugins2(<span class="string">"record"</span>, self, self.records);</span><br><span class="line"></span><br><span class="line">		self.applyPluginsAsync(<span class="string">"additional-assets"</span>, err =&gt; &#123;</span><br><span class="line">			<span class="keyword">if</span>(err) &#123;</span><br><span class="line">				<span class="keyword">return</span> callback(err);</span><br><span class="line">			&#125;</span><br><span class="line">			self.applyPluginsAsync(<span class="string">"optimize-chunk-assets"</span>, self.chunks, err =&gt; &#123;</span><br><span class="line">				<span class="keyword">if</span>(err) &#123;</span><br><span class="line">					<span class="keyword">return</span> callback(err);</span><br><span class="line">				&#125;</span><br><span class="line">				self.applyPlugins1(<span class="string">"after-optimize-chunk-assets"</span>, self.chunks);</span><br><span class="line">				self.applyPluginsAsync(<span class="string">"optimize-assets"</span>, self.assets, err =&gt; &#123;</span><br><span class="line">					<span class="keyword">if</span>(err) &#123;</span><br><span class="line">						<span class="keyword">return</span> callback(err);</span><br><span class="line">					&#125;</span><br><span class="line">					self.applyPlugins1(<span class="string">"after-optimize-assets"</span>, self.assets);</span><br><span class="line">					<span class="keyword">if</span>(self.applyPluginsBailResult(<span class="string">"need-additional-seal"</span>)) &#123;</span><br><span class="line">						self.unseal();</span><br><span class="line">						<span class="keyword">return</span> self.seal(callback);</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">return</span> self.applyPluginsAsync(<span class="string">"after-seal"</span>, callback);</span><br><span class="line">				&#125;);</span><br><span class="line">			&#125;);</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 <code>seal</code> 中可以发现，调用了很多不同的插件，主要就是操作chunk和module的一些插件，生成最后的源代码。其中 <code>createHash</code> 用来生成hash，<code>createChunkAssets</code> 用来生成chunk的源码，<code>createModuleAssets</code> 用来生成Module的源码。在 <code>createChunkAssets</code> 中判断了是否是入口chunk，入口的chunk用mainTemplate生成，否则用chunkTemplate生成。</p>
<h4 id="第五步：通过-emitAssets-将生成的代码输入到output的指定位置"><a href="#第五步：通过-emitAssets-将生成的代码输入到output的指定位置" class="headerlink" title="第五步：通过 emitAssets 将生成的代码输入到output的指定位置"></a>第五步：通过 <code>emitAssets</code> 将生成的代码输入到output的指定位置</h4><p>在compiler中的 <code>run</code> 方法中定义了compile的回调函数 <code>onCompiled</code>, 在编译结束后，会调用该回调函数。在该回调函数中调用了 <code>emitAsset</code>，触发了 <code>emit</code> 事件，将文件写入到文件系统中的指定位置。</p>
<h4 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h4><p>webpack的源码通过采用Tapable控制其事件流，并通过plugin机制，在webpack构建过程中将一些事件钩子暴露给plugin,使得开发者可以通过编写相应的插件来自定义打包。</p>
<p>参考文章：</p>
<p><a href="http://taobaofed.org/blog/2016/09/09/webpack-flow/" target="_blank" rel="noopener">细说 webpack 之流程篇</a></p>
<p><a href="https://lihuanghe.github.io/2016/05/30/webpack-event.html" target="_blank" rel="noopener">webpack 源码解析</a></p>
</div><div class="tags"><a href="/tags/webpack/">webpack</a><a href="/tags/模块打包/">模块打包</a><a href="/tags/源码阅读/">源码阅读</a></div><div class="post-nav"><a href="/2017/08/24/webpack学习系列/" class="pre">webpack学习系列</a><a href="/2017/08/24/vue-cli中的webpack模板配置学习/" class="next">vue-cli中的webpack模板配置学习</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="http://www.monster1935.com"></form></div><div class="widget"><div class="widget-title"><span>分类</span></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Node/">Node</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/前端/">前端</a><span class="category-list-count">36</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/博客搭建/">博客搭建</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/客户端/">客户端</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/生活/">生活</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/算法/">算法</a><span class="category-list-count">1</span></li></ul></div><div class="widget"><div class="widget-title"><span>标签</span></div><div class="tagcloud"><a href="/tags/状态管理/" style="font-size: 15px;">状态管理</a> <a href="/tags/Dom/" style="font-size: 15px;">Dom</a> <a href="/tags/Node-js/" style="font-size: 15px;">Node.js</a> <a href="/tags/this/" style="font-size: 15px;">this</a> <a href="/tags/js/" style="font-size: 15px;">js</a> <a href="/tags/编码规范/" style="font-size: 15px;">编码规范</a> <a href="/tags/React-Native/" style="font-size: 15px;">React Native</a> <a href="/tags/React/" style="font-size: 15px;">React</a> <a href="/tags/CNode/" style="font-size: 15px;">CNode</a> <a href="/tags/文件路径/" style="font-size: 15px;">文件路径</a> <a href="/tags/nodejs/" style="font-size: 15px;">nodejs</a> <a href="/tags/Object/" style="font-size: 15px;">Object</a> <a href="/tags/Vue/" style="font-size: 15px;">Vue</a> <a href="/tags/vue/" style="font-size: 15px;">vue</a> <a href="/tags/vuex/" style="font-size: 15px;">vuex</a> <a href="/tags/icon/" style="font-size: 15px;">icon</a> <a href="/tags/svg/" style="font-size: 15px;">svg</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/gh-pages/" style="font-size: 15px;">gh-pages</a> <a href="/tags/博客搭建/" style="font-size: 15px;">博客搭建</a> <a href="/tags/javascript/" style="font-size: 15px;">javascript</a> <a href="/tags/异步/" style="font-size: 15px;">异步</a> <a href="/tags/class/" style="font-size: 15px;">class</a> <a href="/tags/extends/" style="font-size: 15px;">extends</a> <a href="/tags/prototype/" style="font-size: 15px;">prototype</a> <a href="/tags/单例模式/" style="font-size: 15px;">单例模式</a> <a href="/tags/react/" style="font-size: 15px;">react</a> <a href="/tags/redux/" style="font-size: 15px;">redux</a> <a href="/tags/ES6/" style="font-size: 15px;">ES6</a> <a href="/tags/总结/" style="font-size: 15px;">总结</a> <a href="/tags/年终总结/" style="font-size: 15px;">年终总结</a> <a href="/tags/个人总结/" style="font-size: 15px;">个人总结</a> <a href="/tags/vue-loader/" style="font-size: 15px;">vue-loader</a> <a href="/tags/webpack/" style="font-size: 15px;">webpack</a> <a href="/tags/前端工程化/" style="font-size: 15px;">前端工程化</a> <a href="/tags/vue-cli/" style="font-size: 15px;">vue-cli</a> <a href="/tags/directives/" style="font-size: 15px;">directives</a> <a href="/tags/plugin/" style="font-size: 15px;">plugin</a> <a href="/tags/npm/" style="font-size: 15px;">npm</a> <a href="/tags/数组查找/" style="font-size: 15px;">数组查找</a> <a href="/tags/模块打包/" style="font-size: 15px;">模块打包</a> <a href="/tags/源码阅读/" style="font-size: 15px;">源码阅读</a> <a href="/tags/npx/" style="font-size: 15px;">npx</a> <a href="/tags/数组去重/" style="font-size: 15px;">数组去重</a> <a href="/tags/prototype-chain/" style="font-size: 15px;">prototype chain</a> <a href="/tags/CommonJS/" style="font-size: 15px;">CommonJS</a> <a href="/tags/模块/" style="font-size: 15px;">模块</a> <a href="/tags/HTTP/" style="font-size: 15px;">HTTP</a> <a href="/tags/Cookies/" style="font-size: 15px;">Cookies</a> <a href="/tags/css/" style="font-size: 15px;">css</a> <a href="/tags/JSON/" style="font-size: 15px;">JSON</a> <a href="/tags/RegExp/" style="font-size: 15px;">RegExp</a> <a href="/tags/作用域/" style="font-size: 15px;">作用域</a> <a href="/tags/github/" style="font-size: 15px;">github</a> <a href="/tags/排序/" style="font-size: 15px;">排序</a> <a href="/tags/算法/" style="font-size: 15px;">算法</a></div></div><div class="widget"><div class="widget-title"><span>最近文章</span></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/12/27/redux-and-react-redux/">状态管理之 Redux & React Redux</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/12/23/the-difference-of-extends-behavior-between-ES5-and-ES6/">继承行为在 ES5 与 ES6 中的区别</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/12/23/what-is-npx/">npx 是什么</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/12/21/the-summary-of-year-2019/">即将过去的2019年</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/04/vue单文件探索/">vue 单文件探索</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/03/13/Web Icon 实现方案总结/">Web Icon 实现方案总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/03/02/React Native 初尝试之 CNode 社区客户端开发/">React Native 初尝试之 CNode 社区客户端开发</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/01/vue单文件中引用路径的处理/">vue单文件中引用路径的处理</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/26/DOM中涉及到元素大小的几种计算方式/">DOM中涉及到元素大小的几种计算方式</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/25/关于cookie的总结/">关于Cookie的总结</a></li></ul></div><div class="widget"><div class="widget-title"><span>友情链接</span></div><ul></ul><a href="https://juejin.im/timeline" title="掘金开发者社区" target="_blank">掘金开发者社区</a><ul></ul><a href="https://segmentfault.com/" title="Segmentfault" target="_blank">Segmentfault</a><ul></ul><a href="http://www.zcfy.cc/article#begin" title="众成翻译" target="_blank">众成翻译</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">我的日记本.</a><a rel="nofollow" target="_blank" href="http://www.miitbeian.gov.cn/"> 京ICP备17057625号.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>