<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="记录学习、工作、生活"><title>vue-cli中的webpack模板配置学习 | 李茶德的日记</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.4.0/styles/stackoverflow-dark.min.css"><script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.4.0/highlight.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/img/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">vue-cli中的webpack模板配置学习</h1><a id="logo" href="/.">李茶德的日记</a><p class="description">记录学习、工作、生活</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa null"> 首页</i></a><a href="/archives/"><i class="fa null"> 归档</i></a><a href="/about/"><i class="fa null"> 关于</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1"><div class="content_container"><div class="post"><h1 class="post-title">vue-cli中的webpack模板配置学习</h1><div class="post-meta">2017-08-24<span> | </span><span class="category"><a href="/categories/前端/">前端</a></span></div><div class="post-content"><p>vue-cli是vue官方出品的一个脚手架工具，通过vue-cli可以快速的搭建一个vue的SPA应用的开发框架。其内部提供了多种vue-js-template，作用就是通过相应的template去配置生成项目初期的内容。其中webpack模板提供了全面丰富的webpack配置，包括热重载、单元测试、静态检查以及css提取等功能。</p>
<a id="more"></a>
<p>首先用vue-cli webpack模板生成一个vue的项目，如下：</p>
<p>在确保全局安装了 vue-cli 的前提下，运行下面的命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">vue init webpack webpack_study<br></code></pre></td></tr></table></figure>
<h4 id="项目的文件结构"><a href="#项目的文件结构" class="headerlink" title="项目的文件结构"></a>项目的文件结构</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs bash">├── build/                      <span class="hljs-comment"># webpack 配置文件</span><br>│   └── ...<br>├── config/                     <br>│   ├── index.js                <span class="hljs-comment"># 项目核心配置</span><br>│   └── ...<br>├── src/<br>│   ├── main.js                 <span class="hljs-comment"># 程序入口文件</span><br>│   ├── App.vue                 <span class="hljs-comment"># 程序入口vue组件</span><br>│   ├── components/             <span class="hljs-comment"># 组件</span><br>│   │   └── ...<br>│   └── assets/                 <span class="hljs-comment"># 模块资源 (会被webpack处理)</span><br>│       └── ...<br>├── static/                     <span class="hljs-comment"># 纯静态资源 (直接拷贝到dist/static/里面)</span><br>├── <span class="hljs-built_in">test</span>/<br>│   └── unit/                   <span class="hljs-comment"># 单元测试</span><br>│   │   ├── specs/              <span class="hljs-comment"># 测试规范</span><br>│   │   ├── index.js            <span class="hljs-comment"># 测试入口文件</span><br>│   │   └── karma.conf.js       <span class="hljs-comment"># 测试运行配置文件</span><br>│   └── e2e/                    <span class="hljs-comment"># 端到端测试</span><br>│   │   ├── specs/              <span class="hljs-comment"># 测试规范</span><br>│   │   ├── custom-assertions/  <span class="hljs-comment"># 端到端测试自定义断言</span><br>│   │   ├── runner.js           <span class="hljs-comment"># 运行测试的脚本</span><br>│   │   └── nightwatch.conf.js  <span class="hljs-comment"># 运行测试的配置文件</span><br>├── .babelrc                    <span class="hljs-comment"># babel 配置文件</span><br>├── .editorconfig               <span class="hljs-comment"># 编辑配置文件</span><br>├── .eslintrc.js                <span class="hljs-comment"># eslint 配置文件</span><br>├── index.html                  <span class="hljs-comment"># index.html 入口模板文件</span><br>└── package.json                <span class="hljs-comment"># 运行的脚本与相关依赖</span><br></code></pre></td></tr></table></figure>
<p>进入项目目录，打开package.json 查看其script，</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-string">"scripts"</span>: &#123;<br>    <span class="hljs-string">"dev"</span>: <span class="hljs-string">"node build/dev-server.js"</span>,<br>    <span class="hljs-string">"start"</span>: <span class="hljs-string">"node build/dev-server.js"</span>,<br>    <span class="hljs-string">"build"</span>: <span class="hljs-string">"node build/build.js"</span><br>  &#125;,<br></code></pre></td></tr></table></figure>
<h4 id="开发环境中的配置"><a href="#开发环境中的配置" class="headerlink" title="开发环境中的配置"></a>开发环境中的配置</h4><p>在运行 <code>npm run dev</code> 的时候可以发现，开发环境的入口文件时 build/dev-server.js</p>
<p>dev-server.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 检查node和npm的版本是否匹配，不匹配的话给出提示</span><br><span class="hljs-built_in">require</span>(<span class="hljs-string">'./check-versions'</span>)()<br><br><span class="hljs-keyword">var</span> config = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../config'</span>)<br><span class="hljs-comment">// 如果Node的process变量无法确定当前是开发环境还是生产环境，使用config/index.js下的dev中配置</span><br><span class="hljs-keyword">if</span> (!process.env.NODE_ENV) &#123;<br>  process.env.NODE_ENV = <span class="hljs-built_in">JSON</span>.parse(config.dev.env.NODE_ENV)<br>&#125;<br><span class="hljs-comment">// 跨平台的打开网址、文件等的包</span><br><span class="hljs-comment">// https://www.npmjs.com/package/opn</span><br><span class="hljs-keyword">var</span> opn = <span class="hljs-built_in">require</span>(<span class="hljs-string">'opn'</span>)<br><br><span class="hljs-comment">// node自带的path的模块</span><br><span class="hljs-keyword">var</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>)<br><span class="hljs-comment">// express模块</span><br><span class="hljs-keyword">var</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>)<br><span class="hljs-keyword">var</span> webpack = <span class="hljs-built_in">require</span>(<span class="hljs-string">'webpack'</span>)<br><span class="hljs-comment">// http代理的中间件</span><br><span class="hljs-keyword">var</span> proxyMiddleware = <span class="hljs-built_in">require</span>(<span class="hljs-string">'http-proxy-middleware'</span>)<br><span class="hljs-keyword">var</span> webpackConfig = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./webpack.dev.conf'</span>)<br><br><span class="hljs-comment">// 设置服务器运行的端口号</span><br><span class="hljs-keyword">var</span> port = process.env.PORT || config.dev.port<br><span class="hljs-comment">// 是否开启自动打开浏览器，在config/index.js的dev中配置</span><br><span class="hljs-keyword">var</span> autoOpenBrowser = !!config.dev.autoOpenBrowser<br><span class="hljs-comment">// config/index.js dev中的proxyTable定义了与后端api的代理配置</span><br><span class="hljs-comment">// https://github.com/chimurai/http-proxy-middleware</span><br><span class="hljs-keyword">var</span> proxyTable = config.dev.proxyTable<br><br><span class="hljs-comment">// 启动express的服务</span><br><span class="hljs-keyword">var</span> app = express()<br><span class="hljs-comment">// 使用webpack.dev.conf中配置启动webpack编译</span><br><span class="hljs-keyword">var</span> compiler = webpack(webpackConfig)<br><br><span class="hljs-comment">// 启动webpack-dev-middleware中间件，将编译后的文件写入内存</span><br><span class="hljs-keyword">var</span> devMiddleware = <span class="hljs-built_in">require</span>(<span class="hljs-string">'webpack-dev-middleware'</span>)(compiler, &#123;<br>  <span class="hljs-attr">publicPath</span>: webpackConfig.output.publicPath,<br>  <span class="hljs-attr">quiet</span>: <span class="hljs-literal">true</span><br>&#125;)<br><span class="hljs-comment">// 启动webpack-dev-middleware中间件，也就是hot-reload功能</span><br><span class="hljs-keyword">var</span> hotMiddleware = <span class="hljs-built_in">require</span>(<span class="hljs-string">'webpack-hot-middleware'</span>)(compiler, &#123;<br>  <span class="hljs-attr">log</span>: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;&#125;,<br>  <span class="hljs-attr">heartbeat</span>: <span class="hljs-number">2000</span><br>&#125;)<br><br><span class="hljs-comment">// html-webpack-plugin模板变化后强刷</span><br>compiler.plugin(<span class="hljs-string">'compilation'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">compilation</span>) </span>&#123;<br>  compilation.plugin(<span class="hljs-string">'html-webpack-plugin-after-emit'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">data, cb</span>) </span>&#123;<br>    hotMiddleware.publish(&#123; <span class="hljs-attr">action</span>: <span class="hljs-string">'reload'</span> &#125;)<br>    cb()<br>  &#125;)<br>&#125;)<br><br><span class="hljs-comment">// 应用代理配置中间件</span><br><span class="hljs-built_in">Object</span>.keys(proxyTable).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">context</span>) </span>&#123;<br>  <span class="hljs-keyword">var</span> options = proxyTable[context]<br>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> options === <span class="hljs-string">'string'</span>) &#123;<br>    options = &#123; <span class="hljs-attr">target</span>: options &#125;<br>  &#125;<br>  app.use(proxyMiddleware(options.filter || context, options))<br>&#125;)<br><br><span class="hljs-comment">// 应用connect-history-api-fallback，匹配资源</span><br>app.use(<span class="hljs-built_in">require</span>(<span class="hljs-string">'connect-history-api-fallback'</span>)())<br><br><span class="hljs-comment">// 应用devMiddleware中间件</span><br>app.use(devMiddleware)<br><br><span class="hljs-comment">// 应用hotMiddleware中间件</span><br>app.use(hotMiddleware)<br><br><span class="hljs-comment">// 设置静态资源路径</span><br><span class="hljs-keyword">var</span> staticPath = path.posix.join(config.dev.assetsPublicPath, config.dev.assetsSubDirectory)<br>app.use(staticPath, express.static(<span class="hljs-string">'./static'</span>))<br><br><span class="hljs-keyword">var</span> uri = <span class="hljs-string">'http://localhost:'</span> + port<br><br><span class="hljs-keyword">var</span> _resolve<br><span class="hljs-keyword">var</span> readyPromise = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> &#123;<br>  _resolve = resolve<br>&#125;)<br><br><span class="hljs-comment">// 启动express的服务，并监听</span><br><span class="hljs-built_in">console</span>.log(<span class="hljs-string">'&gt; Starting dev server...'</span>)<br>devMiddleware.waitUntilValid(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;<br>  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'&gt; Listening at '</span> + uri + <span class="hljs-string">'\n'</span>)<br>  <span class="hljs-comment">// when env is testing, don't need open it</span><br>  <span class="hljs-keyword">if</span> (autoOpenBrowser &amp;&amp; process.env.NODE_ENV !== <span class="hljs-string">'testing'</span>) &#123;<br>    opn(uri)<br>  &#125;<br>  _resolve()<br>&#125;)<br><br><span class="hljs-keyword">var</span> server = app.listen(port)<br><br><span class="hljs-built_in">module</span>.exports = &#123;<br>  <span class="hljs-attr">ready</span>: readyPromise,<br>  <span class="hljs-attr">close</span>: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;<br>    server.close()<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>综上，可以发现在dev-server.js 中主要做了这几件事情：</p>
<ul>
<li>获取webpack开发环境的配置文件，并启用webpack编译，获得编译对象compiler</li>
<li>使用webpack-dev-middleware中间件，将编译后的文件写入内存</li>
<li>使用webpack-hot-middleware开启hot-reload功能</li>
<li>启动webpack的服务，并将上述中间件挂在express的服务上</li>
</ul>
<p>webpack模板中并没有使用webpack-dev-server作为开发环境的服务器，而是启动了express的服务并应用了webpack-dev-middleware和webpack-hot-middleware中间件。两种方式实现的功能是一样的，webpack-dev-server的本质也是一个轻量级的express服务，稍后会有webpack-dev-server的原理解析。</p>
<p>webpack.dev.conf.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 工具函数集合</span><br><span class="hljs-keyword">var</span> utils = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./utils'</span>)<br><span class="hljs-keyword">var</span> webpack = <span class="hljs-built_in">require</span>(<span class="hljs-string">'webpack'</span>)<br><span class="hljs-comment">// 配置文件</span><br><span class="hljs-keyword">var</span> config = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../config'</span>)<br><span class="hljs-comment">// webpack配置合并插件</span><br><span class="hljs-keyword">var</span> merge = <span class="hljs-built_in">require</span>(<span class="hljs-string">'webpack-merge'</span>)<br><span class="hljs-comment">// webpack基本配置</span><br><span class="hljs-keyword">var</span> baseWebpackConfig = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./webpack.base.conf'</span>)<br><span class="hljs-comment">// 自动生成html并且注入到.html文件中的插件</span><br><span class="hljs-keyword">var</span> HtmlWebpackPlugin = <span class="hljs-built_in">require</span>(<span class="hljs-string">'html-webpack-plugin'</span>)<br><span class="hljs-comment">// webpack错误信息提示插件</span><br><span class="hljs-keyword">var</span> FriendlyErrorsPlugin = <span class="hljs-built_in">require</span>(<span class="hljs-string">'friendly-errors-webpack-plugin'</span>)<br><br><span class="hljs-comment">// hot-reload 需要在entry中添加一个入口文件，用于客户端与服务端的socket通信</span><br><span class="hljs-built_in">Object</span>.keys(baseWebpackConfig.entry).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">name</span>) </span>&#123;<br>  baseWebpackConfig.entry[name] = [<span class="hljs-string">'./build/dev-client'</span>].concat(baseWebpackConfig.entry[name])<br>&#125;)<br><br><span class="hljs-built_in">module</span>.exports = merge(baseWebpackConfig, &#123;<br>  <span class="hljs-attr">module</span>: &#123;<br>    <span class="hljs-comment">// 关于样式的一些loader</span><br>    rules: utils.styleLoaders(&#123; <span class="hljs-attr">sourceMap</span>: config.dev.cssSourceMap &#125;)<br>  &#125;,<br>  <span class="hljs-comment">// 采用不同形式的source-map</span><br>  devtool: <span class="hljs-string">'#cheap-module-eval-source-map'</span>,<br>  <span class="hljs-comment">// 添加编译过程中使用的插件</span><br>  plugins: [<br>    <span class="hljs-keyword">new</span> webpack.DefinePlugin(&#123;<br>      <span class="hljs-string">'process.env'</span>: config.dev.env<br>    &#125;),<br>    <span class="hljs-comment">// https://github.com/glenjamin/webpack-hot-middleware#installation--usage</span><br>    <span class="hljs-keyword">new</span> webpack.HotModuleReplacementPlugin(),<br>    <span class="hljs-keyword">new</span> webpack.NoEmitOnErrorsPlugin(),<br>    <span class="hljs-comment">// https://github.com/ampedandwired/html-webpack-plugin</span><br>    <span class="hljs-keyword">new</span> HtmlWebpackPlugin(&#123;<br>      <span class="hljs-attr">filename</span>: <span class="hljs-string">'index.html'</span>,<br>      <span class="hljs-attr">template</span>: <span class="hljs-string">'index.html'</span>,<br>      <span class="hljs-attr">inject</span>: <span class="hljs-literal">true</span><br>    &#125;),<br>    <span class="hljs-keyword">new</span> FriendlyErrorsPlugin()<br>  ]<br>&#125;)<br></code></pre></td></tr></table></figure>
<p>在webpack.dev.conf.js中定义了只有在dev环境下用到的一些配置，包括sourcemap以及dev环境下常用的插件集合。在此基础上，通过引入webpack.base.conf.js，将两者merge。</p>
<p>webpack.base.conf.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>)<br><span class="hljs-keyword">var</span> utils = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./utils'</span>)<br><span class="hljs-keyword">var</span> config = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../config'</span>)<br><span class="hljs-keyword">var</span> vueLoaderConfig = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./vue-loader.conf'</span>)<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">resolve</span> (<span class="hljs-params">dir</span>) </span>&#123;<br>  <span class="hljs-keyword">return</span> path.join(__dirname, <span class="hljs-string">'..'</span>, dir)<br>&#125;<br><br><span class="hljs-built_in">module</span>.exports = &#123;<br>  <span class="hljs-attr">entry</span>: &#123;<br>    <span class="hljs-attr">app</span>: <span class="hljs-string">'./src/main.js'</span><br>  &#125;,<br>  <span class="hljs-attr">output</span>: &#123;<br>    <span class="hljs-comment">// 编译结束后输入的静态资源目标路径</span><br>    path: config.build.assetsRoot,<br>    <span class="hljs-comment">// 对应的bundle的文件名</span><br>    filename: <span class="hljs-string">'[name].js'</span>,<br>    <span class="hljs-comment">// 正式发布环境下编译输出的线上路径的根路径</span><br>    publicPath: process.env.NODE_ENV === <span class="hljs-string">'production'</span><br>      ? config.build.assetsPublicPath<br>      : config.dev.assetsPublicPath<br>  &#125;,<br>  <span class="hljs-attr">resolve</span>: &#123;<br>    <span class="hljs-comment">// 后缀名自动补全</span><br>    extensions: [<span class="hljs-string">'.js'</span>, <span class="hljs-string">'.vue'</span>, <span class="hljs-string">'.json'</span>],<br>    <span class="hljs-comment">// 别名</span><br>    alias: &#123;<br>      <span class="hljs-string">'vue$'</span>: <span class="hljs-string">'vue/dist/vue.esm.js'</span>,<br>      <span class="hljs-string">'@'</span>: resolve(<span class="hljs-string">'src'</span>)<br>    &#125;<br>  &#125;,<br>  <span class="hljs-attr">module</span>: &#123;<br>    <span class="hljs-comment">// 各种处理模块的loader</span><br>    rules: [<br>      &#123;<br>        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.vue$/</span>,<br>        <span class="hljs-attr">loader</span>: <span class="hljs-string">'vue-loader'</span>,<br>        <span class="hljs-attr">options</span>: vueLoaderConfig<br>      &#125;,<br>      &#123;<br>        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.js$/</span>,<br>        <span class="hljs-attr">loader</span>: <span class="hljs-string">'babel-loader'</span>,<br>        <span class="hljs-attr">include</span>: [resolve(<span class="hljs-string">'src'</span>), resolve(<span class="hljs-string">'test'</span>)]<br>      &#125;,<br>      &#123;<br>        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.(png|jpe?g|gif|svg)(\?.*)?$/</span>,<br>        <span class="hljs-attr">loader</span>: <span class="hljs-string">'url-loader'</span>,<br>        <span class="hljs-attr">options</span>: &#123;<br>          <span class="hljs-attr">limit</span>: <span class="hljs-number">10000</span>,<br>          <span class="hljs-attr">name</span>: utils.assetsPath(<span class="hljs-string">'img/[name].[hash:7].[ext]'</span>)<br>        &#125;<br>      &#125;,<br>      &#123;<br>        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.(mp4|webm|ogg|mp3|wav|flac|aac)(\?.*)?$/</span>,<br>        <span class="hljs-attr">loader</span>: <span class="hljs-string">'url-loader'</span>,<br>        <span class="hljs-attr">options</span>: &#123;<br>          <span class="hljs-attr">limit</span>: <span class="hljs-number">10000</span>,<br>          <span class="hljs-attr">name</span>: utils.assetsPath(<span class="hljs-string">'media/[name].[hash:7].[ext]'</span>)<br>        &#125;<br>      &#125;,<br>      &#123;<br>        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.(woff2?|eot|ttf|otf)(\?.*)?$/</span>,<br>        <span class="hljs-attr">loader</span>: <span class="hljs-string">'url-loader'</span>,<br>        <span class="hljs-attr">options</span>: &#123;<br>          <span class="hljs-attr">limit</span>: <span class="hljs-number">10000</span>,<br>          <span class="hljs-attr">name</span>: utils.assetsPath(<span class="hljs-string">'fonts/[name].[hash:7].[ext]'</span>)<br>        &#125;<br>      &#125;<br>    ]<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>webpack.base.conf.js中定义了webpack编译的一些公共配置。</p>
<p>config/index.js中定义了生产环境以及开发环境的配置文件，主要是根据该文件，生成webpack配置文件供编译时使用。比如端口号、代理配置等</p>
<p>util.js主要定义了几个工具函数，包括生成静态资源路径，生成styleLoaders的配置等。</p>
<h4 id="生产环境中的配置"><a href="#生产环境中的配置" class="headerlink" title="生产环境中的配置"></a>生产环境中的配置</h4><p>执行 <code>npm run build</code>的时候，可以发现生产环境的入口是build/build.js</p>
<p>build/build.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-built_in">require</span>(<span class="hljs-string">'./check-versions'</span>)()<br><br>process.env.NODE_ENV = <span class="hljs-string">'production'</span><br><br><span class="hljs-comment">// 终端显示loading效果的工具</span><br><span class="hljs-keyword">var</span> ora = <span class="hljs-built_in">require</span>(<span class="hljs-string">'ora'</span>)<br><span class="hljs-comment">// node中执行 rm -rf的工具</span><br><span class="hljs-keyword">var</span> rm = <span class="hljs-built_in">require</span>(<span class="hljs-string">'rimraf'</span>)<br><span class="hljs-keyword">var</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>)<br><span class="hljs-comment">// 带颜色的输出</span><br><span class="hljs-keyword">var</span> chalk = <span class="hljs-built_in">require</span>(<span class="hljs-string">'chalk'</span>)<br><span class="hljs-keyword">var</span> webpack = <span class="hljs-built_in">require</span>(<span class="hljs-string">'webpack'</span>)<br><span class="hljs-keyword">var</span> config = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../config'</span>)<br><span class="hljs-comment">// 生产环境下的webpack配置文件</span><br><span class="hljs-keyword">var</span> webpackConfig = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./webpack.prod.conf'</span>)<br><br><span class="hljs-comment">// 在命令行显示loading效果</span><br><span class="hljs-keyword">var</span> spinner = ora(<span class="hljs-string">'building for production...'</span>)<br>spinner.start()<br><br><span class="hljs-comment">// 删除文件</span><br>rm(path.join(config.build.assetsRoot, config.build.assetsSubDirectory), err =&gt; &#123;<br>  <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">throw</span> err<br>  <span class="hljs-comment">// 带回调的webpack函数，编译完后调用该callback</span><br>  webpack(webpackConfig, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, stats</span>) </span>&#123;<br>    spinner.stop()<br>    <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">throw</span> err<br>    process.stdout.write(stats.toString(&#123;<br>      <span class="hljs-attr">colors</span>: <span class="hljs-literal">true</span>,<br>      <span class="hljs-attr">modules</span>: <span class="hljs-literal">false</span>,<br>      <span class="hljs-attr">children</span>: <span class="hljs-literal">false</span>,<br>      <span class="hljs-attr">chunks</span>: <span class="hljs-literal">false</span>,<br>      <span class="hljs-attr">chunkModules</span>: <span class="hljs-literal">false</span><br>    &#125;) + <span class="hljs-string">'\n\n'</span>)<br><br>    <span class="hljs-built_in">console</span>.log(chalk.cyan(<span class="hljs-string">'  Build complete.\n'</span>))<br>    <span class="hljs-built_in">console</span>.log(chalk.yellow(<br>      <span class="hljs-string">'  Tip: built files are meant to be served over an HTTP server.\n'</span> +<br>      <span class="hljs-string">'  Opening index.html over file:// won\'t work.\n'</span><br>    ))<br>  &#125;)<br>&#125;)<br></code></pre></td></tr></table></figure>
<p>build/build.js主要完成了删除之前的文件，执行编译动作，将文件写入指定文件位置，并在控制台上输出信息的任务。</p>
<p>webpack.prod.conf.js中定义了在执行build命令时webpack的一些配置。与webpack.dev.conf.js的主要差别在于一些插件的使用。比如在prod环境下添加了一些压缩文件、提取公共文件、复制静态资源一类的插件。这些都是在生产环境下才会应用的一些配置。</p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>通读vue-cli webpack模板的配置可以发现，其配置文件主要分为了两部分，一是dev环境下，二是prod环境下的配置文件。在此基础还抽离出了不同环境下公共的webpack.base.conf.js。再者config.js抽离了两环境下的一些配置，这样用户就不用去具体的webpack的配置文件中去设置相关配置，只需在config.js中即可完成。util.js提供了相关的工具函数，用于更简便的输出webpack配置文件。</p>
<p>参考文章：</p>
<p><a href="https://loulanyijian.github.io/vue-cli-doc-Chinese/" target="_blank" rel="noopener">vue-cli webpack模板中文文档</a></p>
<p><a href="https://github.com/DDFE/DDFE-blog/issues/10" target="_blank" rel="noopener">vue-cli#2.0 webpack 配置分析</a></p>
<p><a href="https://segmentfault.com/a/1190000008644830" target="_blank" rel="noopener">vue-cli webpack配置分析</a></p>
</div><div class="tags"><a href="/tags/webpack/">webpack</a><a href="/tags/前端工程化/">前端工程化</a><a href="/tags/vue-cli/">vue-cli</a></div><div class="post-nav"><a href="/2017/08/24/webpack构建流程探底/" class="pre">webpack构建流程探底</a><a href="/2017/08/24/webpack常用插件及其作用/" class="next">webpack常用插件及其作用</a></div></div></div></div><div class="pure-u-1"><div id="footer">Copyright © 2020 <a href="/." rel="nofollow">李茶德的日记.</a><a rel="nofollow" target="_blank" href="http://www.beian.miit.gov.cn"> 京ICP备17057625号.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>